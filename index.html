<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agregar Corte</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 15px;
        background: #f5f5f5;
    }

    /* Estilos para entradas de formulario */
    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
        color: #333;
    }
    input[type="text"], input[type="number"], select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box; /* Importante para que el padding no afecte el width total */
    }
    textarea {
        resize: vertical;
        min-height: 80px;
    }

    .step {
        display: none;
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .step.active {
        display: block;
    }

    .btn {
        background: #007bff; /* Azul primario */
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        margin-top: 15px;
        transition: background 0.3s;
    }

    .btn:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d; /* Gris secundario */
    }
    .btn-secondary:hover {
        background: #5a6268;
    }

    .loading {
        display: none;
        font-size: 18px;
        margin-top: 20px;
        text-align: center;
        color: #007bff;
        font-weight: bold;
    }

    .image-preview {
        width: 100%;
        max-width: 300px;
        height: auto;
        margin: 10px 0;
        display: none;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    
    .opcion {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        font-weight: 500;
        color: #333;
    }
    .opcion:hover {
        background: #dee2e6;
        border-color: #007bff;
    }

    .opcion-info {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }

</style>
</head>

<body>

<h2>Ingreso de Información de Cortes</h2>

<div id="loading" class="loading">⏳ Procesando, por favor espera...</div>
<div id="messageBox" style="display:none; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: bold;"></div>


<!-- PASO 1: DATOS BÁSICOS -->
<div id="step1" class="step active">
    <h3>1. Datos del Modelo</h3>

    <label for="colaborador">Colaborador</label>
    <input type="text" id="colaborador" required>

    <label for="categoria">Categoría</label>
    <select id="categoria"></select>

    <label for="marca">Marca</label>
    <input type="text" id="marca" required>

    <label for="modelo">Modelo</label>
    <input type="text" id="modelo" required>

    <label for="anio">Año</label>
    <input type="number" id="anio" min="1900" max="2100" required>

    <label for="imagenVehiculo">Imagen del vehículo (Opcional)</label>
    <input type="file" id="imagenVehiculo" accept="image/*">
    <img id="previewVehiculo" class="image-preview" alt="Vista previa del vehículo">

    <button class="btn" onclick="validarModelo()">Buscar Modelo</button>
</div>


<!-- PASO 2: SELECCIÓN DE ACCIÓN -->
<div id="step2" class="step">
    <h3>2. Modelo Encontrado</h3>
    <p id="infoExistente" style="font-weight: bold;"></p>

    <h4>¿Qué deseas agregar o actualizar?</h4>

    <div id="opciones"></div>

    <button class="btn-secondary" onclick="volverPaso1()">Regresar</button>
</div>


<!-- PASO 3: FORMULARIO DINÁMICO -->
<div id="step3" class="step">
    <h3 id="tituloStep3"></h3>

    <div id="contenidoStep3"></div>
    
    <!-- Campos Comunes -->
    <label for="comoDesarmarPlasticos">Cómo desarmar plásticos (Opcional)</label>
    <textarea id="comoDesarmarPlasticos"></textarea>

    <label for="notaImportante">Nota Importante (Opcional)</label>
    <textarea id="notaImportante"></textarea>
    
    <label for="colaboradorFinal">Colaborador (Confirmar)</label>
    <input type="text" id="colaboradorFinal" required>
    
    <button class="btn" onclick="enviar()">Enviar</button>
    <button class="btn-secondary" onclick="volverPaso2()">Regresar</button>
</div>



<script>
// *** URL ACTUALIZADA CON EL VALOR PROPORCIONADO POR EL USUARIO ***
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyxA2MYxgZqLXip-qTtD_q3LuHn9HlRFRnmMKeOJX5JRKsamzrr0MfEl0Z8ysHYtyHaQ/exec";

// Estados globales
let imagenVehiculoBase64 = "";
let imagenCorteBase64 = "";
let imagenAperturaBase64 = "";
let imagenCablesBase64 = "";

let datosEncontrados = null; // Almacena la respuesta de buscarModelo
let validaciones = null;     // Almacena los arrays de validación
let accionSeleccionada = "";


// ------------------------------------
// Manejo de UI (Mensajes y Pasos)
// ------------------------------------

function showMessage(text, isError = false) {
    const box = document.getElementById("messageBox");
    box.innerText = text;
    box.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
    box.style.color = isError ? '#721c24' : '#155724';
    box.style.border = `1px solid ${isError ? '#f5c6cb' : '#c3e6cb'}`;
    box.style.display = 'block';
    setTimeout(() => { box.style.display = 'none'; }, 5000);
}

function setLoading(isLoading) {
    document.getElementById("loading").style.display = isLoading ? "block" : "none";
}

function mostrarPaso(n){
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    document.getElementById("step" + n).classList.add("active");
    // Sincronizar colaborador
    if (n === 3) {
        document.getElementById("colaboradorFinal").value = document.getElementById("colaborador").value;
    }
}

function volverPaso1(){
    mostrarPaso(1);
}

function volverPaso2(){
    mostrarPaso(2);
}


// ------------------------------------
// Inicialización y Carga de Datos
// ------------------------------------

window.onload = async () => {
    // 1. Cargar datos de validación
    try {
        setLoading(true);
        let res = await fetch(WEB_APP_URL + "?action=getValidationData");
        validaciones = await res.json();
        setLoading(false);

        if (validaciones.error) {
            showMessage("Error al cargar datos de validación: " + validaciones.error, true);
            return;
        }

        // 2. Llenar el select de Categorías
        const catSelect = document.getElementById("categoria");
        validaciones.categorias.forEach(c => {
            let op = document.createElement("option");
            op.value = c;
            op.innerText = c;
            catSelect.appendChild(op);
        });

    } catch (e) {
        setLoading(false);
        showMessage("Error al inicializar la aplicación. Verifica la conexión con Apps Script.", true);
    }
};


// ------------------------------------
// Manejo de Archivos (Base64)
// ------------------------------------

function readFileAsBase64(fileInput, callback) {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e){
        callback(e.target.result, file.name);
    };
    reader.readAsDataURL(file);
}

// Previsualización Imagen Vehículo
document.getElementById("imagenVehiculo").addEventListener("change", function(){
    readFileAsBase64(this, (base64, name) => {
        imagenVehiculoBase64 = base64;
        document.getElementById("previewVehiculo").src = base64;
        document.getElementById("previewVehiculo").style.display = "block";
    });
});


// ------------------------------------
// PASO 1: Validación y Búsqueda
// ------------------------------------

async function validarModelo(){
    const marca = document.getElementById("marca").value.trim();
    const modelo = document.getElementById("modelo").value.trim();
    const anio = document.getElementById("anio").value.trim();
    const colaborador = document.getElementById("colaborador").value.trim();

    if (!marca || !modelo || !anio || !colaborador) {
        showMessage("Por favor, completa Marca, Modelo, Año y Colaborador.", false);
        return;
    }
    
    // Asegurar que el año es un número
    const anioNum = Number(anio);
    if (isNaN(anioNum) || anioNum < 1900 || anioNum > 2100) {
        showMessage("El año debe ser un número válido.", true);
        return;
    }


    setLoading(true);
    try {
        const url = `${WEB_APP_URL}?action=buscarModelo&marca=${encodeURIComponent(marca)}&modelo=${encodeURIComponent(modelo)}&anio=${anioNum}`;
        let res = await fetch(url);
        datosEncontrados = await res.json();
        setLoading(false);
        
        if (datosEncontrados.error) {
            showMessage("Error en la búsqueda: " + datosEncontrados.error, true);
            return;
        }

        if (datosEncontrados.existe === false){
            // Modelo no encontrado: Registrar modelo nuevo
            accionSeleccionada = "nuevoModelo";
            mostrarPaso(3);
            generarFormularioModeloNuevo();
        } else {
            // Modelo encontrado: Mostrar opciones de actualización
            document.getElementById("infoExistente").innerText = `Modelo: ${marca} ${modelo} (${anioNum}). Fila #${datosEncontrados.rowIndex}.`;
            mostrarPaso(2);
            mostrarOpcionesExistentes(datosEncontrados);
        }

    } catch (e) {
        setLoading(false);
        showMessage("Error de comunicación con Apps Script durante la búsqueda.", true);
    }
}


// ------------------------------------
// PASO 2: Opciones de Actualización
// ------------------------------------

function mostrarOpcionesExistentes(info){
    const opciones = document.getElementById("opciones");
    opciones.innerHTML = "";
    
    let html = '';

    // Opción para Cortes
    if (!info.tieneCorte2 || !info.tieneCorte3){
        let mensaje = "";
        if (!info.tieneCorte2) mensaje = " (Corte 2 disponible)";
        else if (!info.tieneCorte3) mensaje = " (Corte 3 disponible)";

        html += `<div class="opcion" onclick="seleccionarAccion('corteNuevo')">
                    Agregar Corte Nuevo ${mensaje}
                    <div class="opcion-info">${info.tieneCorte1 ? 'Ya tiene Corte 1.' : 'ERROR: No tiene Corte 1'}</div>
                 </div>`;
    }

    // Opción para Apertura
    if (!info.tieneApertura){
        html += `<div class="opcion" onclick="seleccionarAccion('apertura')">
                    Agregar Apertura
                 </div>`;
    }

    // Opción para Cables
    if (!info.tieneCables){
        html += `<div class="opcion" onclick="seleccionarAccion('cables')">
                    Agregar Cables de Alimentación
                 </div>`;
    }
    
    // Opción para Imagen de Vehículo
    html += `<div class="opcion" onclick="seleccionarAccion('imagenVehiculoUpdate')">
                Actualizar Imagen del Vehículo
             </div>`;
             
    opciones.innerHTML = html;
}

function seleccionarAccion(accion){
    accionSeleccionada = accion;
    mostrarPaso(3);
    
    switch(accion) {
        case 'nuevoModelo':
            generarFormularioModeloNuevo();
            break;
        case 'corteNuevo':
            generarFormularioCorte();
            break;
        case 'apertura':
            generarFormularioApertura();
            break;
        case 'cables':
            generarFormularioCables();
            break;
        case 'imagenVehiculoUpdate':
            generarFormularioImagenVehiculo();
            break;
    }
}


// ------------------------------------
// PASO 3: Generación de Formularios Dinámicos
// ------------------------------------

function generarSelectHtml(id, values, label, isRequired = true) {
    let required = isRequired ? 'required' : '';
    let options = values.map(v => `<option value="${v}">${v}</option>`).join('');
    return `
        <label for="${id}">${label}</label>
        <select id="${id}" ${required}>
            ${options}
        </select>
    `;
}

// Handler para cargar imagen en un formulario dinámico
function setupImageHandler(inputId, base64VarName) {
    const input = document.getElementById(inputId);
    input.addEventListener("change", function() {
        readFileAsBase64(this, (base64, name) => {
            // Asigna la base64 a la variable global correspondiente
            eval(`${base64VarName} = base64`); 
            
            const previewId = `preview${inputId}`;
            let preview = document.getElementById(previewId);
            if (!preview) {
                // Si la previsualización no existe, la crea
                preview = document.createElement('img');
                preview.id = previewId;
                preview.className = 'image-preview';
                input.parentNode.insertBefore(preview, input.nextSibling);
            }
            preview.src = base64;
            preview.style.display = "block";
            preview.alt = `Vista previa de ${name}`;
            preview.dataset.filename = name; // Guardar nombre original
        });
    });
}

function getBase64Data(inputId, base64VarName) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(`preview${inputId}`);
    
    if (eval(base64VarName)) {
         return { 
            base64: eval(base64VarName), 
            name: preview ? preview.dataset.filename : input.files[0]?.name || 'imagen.png' 
        };
    }
    return null;
}


// Formulario para registrar un modelo totalmente nuevo
function generarFormularioModeloNuevo(){
    document.getElementById("tituloStep3").innerText = "3. Registrar Modelo Nuevo";
    
    const tipoEncendidoSelect = generarSelectHtml("tipoEncendido", validaciones.tipoEncendido, "Tipo de encendido");
    const tipoCorteSelect = generarSelectHtml("tipoCorte1", validaciones.tipoCorte, "Tipo de corte 1");
    
    document.getElementById("contenidoStep3").innerHTML = `
        ${tipoEncendidoSelect}

        <h4>Corte Inicial (Corte 1)</h4>
        ${tipoCorteSelect}

        <label for="descCorte1">Descripción corte 1</label>
        <textarea id="descCorte1" required></textarea>

        <label for="imgCorte1">Imagen del corte 1</label>
        <input type="file" id="imgCorte1" accept="image/*" required>
    `;
    
    // Adjuntar handlers de imagen
    setupImageHandler('imgCorte1', 'imagenCorteBase64');
}


// Formulario para agregar un corte adicional
function generarFormularioCorte(){
    document.getElementById("tituloStep3").innerText = "3. Agregar Corte Adicional";

    const tipoCorteSelect = generarSelectHtml("tipoCorte", validaciones.tipoCorte, "Tipo de corte");

    document.getElementById("contenidoStep3").innerHTML = `
        ${tipoCorteSelect}

        <label for="descripcionCorte">Descripción</label>
        <textarea id="descripcionCorte" required></textarea>

        <label for="imgCorte">Imagen del corte</label>
        <input type="file" id="imgCorte" accept="image/*" required>
    `;
    
    // Adjuntar handlers de imagen
    setupImageHandler('imgCorte', 'imagenCorteBase64');
}

// Formulario para agregar apertura
function generarFormularioApertura(){
    document.getElementById("tituloStep3").innerText = "3. Agregar Apertura";

    document.getElementById("contenidoStep3").innerHTML = `
        <label for="descApertura">Descripción apertura</label>
        <textarea id="descApertura" required></textarea>

        <label for="imgApertura">Imagen apertura</label>
        <input type="file" id="imgApertura" accept="image/*" required>
    `;
    
    // Adjuntar handlers de imagen
    setupImageHandler('imgApertura', 'imagenAperturaBase64');
}

// Formulario para agregar cables
function generarFormularioCables(){
    document.getElementById("tituloStep3").innerText = "3. Agregar Cables de Alimentación";

    document.getElementById("contenidoStep3").innerHTML = `
        <label for="descCables">Descripción cables</label>
        <textarea id="descCables" required></textarea>

        <label for="imgCables">Imagen cables</label>
        <input type="file" id="imgCables" accept="image/*" required>
    `;
    
    // Adjuntar handlers de imagen
    setupImageHandler('imgCables', 'imagenCablesBase64');
}

// Formulario para actualizar imagen del vehículo
function generarFormularioImagenVehiculo(){
    document.getElementById("tituloStep3").innerText = "3. Actualizar Imagen del Vehículo";

    document.getElementById("contenidoStep3").innerHTML = `
        <label for="imgVehiculoUpdate">Selecciona la nueva imagen del vehículo</label>
        <input type="file" id="imgVehiculoUpdate" accept="image/*" required>
        <img id="previewimgVehiculoUpdate" class="image-preview" alt="Nueva imagen del vehículo">
    `;
    
    // Adjuntar handlers de imagen
    setupImageHandler('imgVehiculoUpdate', 'imagenVehiculoBase64');
}


// ------------------------------------
// PASO 3: Enviar Formulario
// ------------------------------------

async function enviar(){
    const colaborador = document.getElementById("colaboradorFinal").value.trim();
    const categoria = document.getElementById("categoria").value;
    const marca = document.getElementById("marca").value.trim();
    const modelo = document.getElementById("modelo").value.trim();
    const anio = Number(document.getElementById("anio").value);
    const plasticos = document.getElementById("comoDesarmarPlasticos").value.trim();
    const nota = document.getElementById("notaImportante").value.trim();
    
    if (!colaborador) {
        showMessage("El campo Colaborador (Confirmar) es obligatorio.", true);
        return;
    }

    const payload = {
        colaborador,
        categoria,
        marca,
        modelo,
        anio,
        comoDesarmarPlasticos: plasticos,
        notaImportante: nota,
        accion: accionSeleccionada,
    };
    
    // Si estamos actualizando una fila existente, incluimos el rowIndex
    if (datosEncontrados && datosEncontrados.existe) {
        payload.rowIndex = datosEncontrados.rowIndex;
    }

    // Lógica para adjuntar datos específicos según la acción
    let valid = true;
    
    switch(accionSeleccionada) {
        case 'nuevoModelo':
            const tipoEncendido = document.getElementById("tipoEncendido").value;
            const tipoCorte1 = document.getElementById("tipoCorte1").value;
            const descCorte1 = document.getElementById("descCorte1").value.trim();
            const imgCorte1Data = getBase64Data('imgCorte1', 'imagenCorteBase64');

            if (!tipoEncendido || !tipoCorte1 || !descCorte1 || !imgCorte1Data) { valid = false; break; }
            
            payload.tipoEncendido = tipoEncendido;
            payload.imagenVehiculo = getBase64Data('imagenVehiculo', 'imagenVehiculoBase64'); // Opcional, pero se envía si existe
            payload.corte1 = { 
                tipoCorte: tipoCorte1, 
                descripcion: descCorte1, 
                imagen: imgCorte1Data 
            };
            break;

        case 'corteNuevo':
            const tipoCorte = document.getElementById("tipoCorte").value;
            const descripcionCorte = document.getElementById("descripcionCorte").value.trim();
            const imgCorteData = getBase64Data('imgCorte', 'imagenCorteBase64');

            if (!tipoCorte || !descripcionCorte || !imgCorteData) { valid = false; break; }
            
            payload.corte = { 
                tipoCorte: tipoCorte, 
                descripcion: descripcionCorte, 
                imagen: imgCorteData 
            };
            break;

        case 'apertura':
            const descApertura = document.getElementById("descApertura").value.trim();
            const imgAperturaData = getBase64Data('imgApertura', 'imagenAperturaBase64');

            if (!descApertura || !imgAperturaData) { valid = false; break; }
            
            payload.apertura = { 
                descripcion: descApertura, 
                imagen: imgAperturaData 
            };
            break;

        case 'cables':
            const descCables = document.getElementById("descCables").value.trim();
            const imgCablesData = getBase64Data('imgCables', 'imagenCablesBase64');

            if (!descCables || !imgCablesData) { valid = false; break; }
            
            payload.cables = { 
                descripcion: descCables, 
                imagen: imgCablesData 
            };
            break;

        case 'imagenVehiculoUpdate':
            const imgVehiculoUpdateData = getBase64Data('imgVehiculoUpdate', 'imagenVehiculoBase64');
            
            if (!imgVehiculoUpdateData) { valid = false; break; }
            
            payload.imagenVehiculo = imgVehiculoUpdateData;
            break;
    }

    if (!valid) {
        showMessage("Por favor, completa todos los campos requeridos y sube la imagen.", true);
        return;
    }


    setLoading(true);
    try {
        const res = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const jsonResponse = await res.json();
        setLoading(false);

        if (jsonResponse.success) {
            showMessage(jsonResponse.message || "Guardado correctamente.");
            // Recargar la página después de un guardado exitoso
            setTimeout(() => { location.reload(); }, 1500); 
        } else {
            showMessage(jsonResponse.error || "Error desconocido al guardar.", true);
        }

    } catch (e) {
        setLoading(false);
        showMessage("Error de comunicación con Apps Script durante el envío de datos.", true);
    }
}

</script>

</body>
</html>
