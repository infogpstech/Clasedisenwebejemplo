<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Cortes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Carga de Google Sheets API -->
<script src="https://apis.google.com/js/api.js"></script>
<style>
/* Estilos Globales */
html {
    height: 100%;
}
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    min-height: 100%;
}
h1,h2,h3,h4 {
    margin: 10px 0;
}
.container {
    padding: 20px;
    max-width: 1240px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    flex: 1 0 auto;
}
/* Estilo del contenedor del formulario para centrarlo dentro del contenedor general (similar al que ten√≠as) */
.form-card {
    max-width: 500px;
    margin: 20px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.backBtn {
    margin-bottom: 15px;
    cursor: pointer;
    color: #007bff;
    display: inline-flex;
    align-items: center;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}
.backBtn:hover {
    background: #e9f7ff;
}

/* --- ESTILOS DEL ENCABEZADO (Header) --- */
.header-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin-bottom: 20px;
    padding: 20px 20px 0 20px; /* Para que coincida con el padding del container */
    max-width: 1240px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
}
.app-logo {
    max-width: 96px;
    height: auto;
    border-radius: 8px;
    margin-right: 15px;
}
h1.app-title {
    text-align: left;
    margin: 0;
    font-size: 2.2em;
    color: #333;
}

#install-button {
    display: none; 
    position: fixed; 
    top: 20px;       
    right: 20px;     
    z-index: 1001;   
    padding: 10px 20px;
    font-size: 1em;
    font-weight: bold;
    color: #fff;
    background-color: #28a745; 
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    white-space: nowrap;
}

#install-button:hover {
    background-color: #218838;
    transform: scale(1.05); 
}

@media (max-width: 480px) {
    .header-container {
         padding: 10px 10px 0 10px;
    }
    h1.app-title {
        font-size: 1.8em;
    }
    #install-button {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.9em;
    }
}

/* --- ESTILOS DEL FORMULARIO Y PASOS (Form, Steps) --- */
.step {
    display: none;
}

.step.active {
    display: block;
}

label {
    display: block;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

input[type="text"], input[type="number"], select, textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 1em;
    transition: border-color 0.3s;
}
input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.5);
    outline: none;
}

/* --- NUEVOS ESTILOS PARA LA SELECCI√ìN DE ARCHIVOS --- */

/* Ocultar el input file nativo */
.input-file-hidden {
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
}

/* Estilo para el bot√≥n/label que reemplaza el input file */
.custom-file-upload {
    display: block;
    width: 100%;
    padding: 10px;
    margin-bottom: 15px; /* Espacio despu√©s del bot√≥n */
    border: 1px solid #007bff;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 1em;
    font-weight: 500;
    color: #007bff;
    background-color: #f0f8ff; /* Fondo azul muy claro */
    cursor: pointer;
    text-align: center;
    transition: background-color 0.3s, border-color 0.3s;
}

.custom-file-upload:hover {
    background-color: #e9f7ff;
    border-color: #0056b3;
}
/* Fin de Estilos para el Input File */

/* Estilos de Botones */
.btn {
    background: #007bff; /* Azul */
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    font-size: 1em;
    font-weight: bold;
    transition: background-color 0.3s;
}

.btn:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d; /* Gris */
}
.btn-secondary:hover {
    background: #5a6268;
}

.loading {
    display: none;
    font-size: 1em;
    margin-top: 15px;
    text-align: center;
    color: #007bff;
    font-weight: bold;
}

.image-preview {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin-top: 5px; /* Ajuste de espacio */
    margin-bottom: 15px; /* Espacio despu√©s de la previsualizaci√≥n */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    object-fit: contain;
}

/* Alerta flotante para mensajes */
.alerta {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 25px;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.5s, transform 0.5s;
    text-align: center;
    max-width: 90%;
}
.alerta.show {
    opacity: 1;
    transform: translate(-50%, 0);
}
.alerta.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.alerta.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.alerta.info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* Estilos espec√≠ficos para la informaci√≥n de cortes existentes */
.cortes-existentes-info {
    padding: 10px;
    margin-bottom: 15px;
    background-color: #fff3cd; /* Yellow tint for info */
    border: 1px solid #ffeeba;
    border-radius: 8px;
}
.cortes-existentes-info p {
    margin: 5px 0;
}
.footer {
    text-align: center;
    padding: 20px 0;
    margin-top: 40px;
    background-color: #333;
    color: #fff;
    font-size: 0.9em;
    flex-shrink: 0;
}

/* Incluidos por el usuario (no usados en este form, pero mantenidos) */
.search-container { margin-bottom: 30px; padding: 10px 0; max-width: 600px; margin-left: auto; margin-right: auto; }
.search-container input[type="text"]:focus { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); outline: none; }
.section-selector { display: flex; justify-content: center; margin-bottom: 20px; }
.section-btn { background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; padding: 10px 20px; margin: 0 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s, color 0.3s; }
.section-btn.active { background-color: #007bff; color: #fff; border-color: #007bff; }
.section-btn:hover:not(.active) { background-color: #e0e0e0; }
.grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, 140px); justify-content: center; max-width: 1200px; margin: 0 auto; }
.card { position: relative; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); cursor: pointer; padding: 0; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; width: 100%; max-width: 140px; justify-self: center; }
.card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
.card img { width: 100%; height: 120px; object-fit: contain; display: block; border-radius: 0; }
.overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%); color: #fff; padding: 10px 8px 8px 8px; font-size: 0.9em; line-height: 1.3; font-weight: bold; border-radius: 0; z-index: 10; }
#modalDetalle{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.8); color:#000; z-index:999; }
#detalleCompleto{ background:#fff; margin:50px auto; padding:30px; max-width:90%; border-radius:15px; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
#detalleCompleto img{ max-width:100%; max-height:60vh; margin-bottom:15px; cursor:pointer; object-fit:contain; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
#detalleCompleto h4 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 5px; }
.lightbox{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:1000; }
.lightbox img{max-width:95%; max-height:95%;}
</style>
</head>
<body>
<!-- ENCABEZADO PROPORCIONADO POR EL USUARIO -->
<div class="header-container">
    <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
    <h1 class="app-title">GPSpedia</h1>
    <button id="install-button" style="display: none;">Instalar Aplicaci√≥n</button>
</div>

<div class="container">
    <div class="form-card">
        <h1 class="text-2xl font-bold mb-6 text-gray-800 text-center">Registro de Corte de Veh√≠culo</h1>

        <!-- ============================================================= -->
        <!-- CONFIGURACI√ìN H√çBRIDA (APIs y Apps Script) -->
        <!-- ============================================================= -->
        <script>
        // 1. URL de Apps Script (Solo para guardar im√°genes en Drive y devolver URLs)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpUQoEEb5Q-9CwprRGnwJFFY_RD9V6FYnl53yJPkBSiEJ17tLdY5bwkIRJdy061yj8/exec'; 
        
        // 2. ID de la Hoja de C√°lculo de Google
        const SPREADSHEET_ID = '1jEdC2NMc2a5F36xE2MJfgxMZiZFVfeDqnCdVizNGIMo'; 

        // 3. API Key (Clave p√∫blica) de Google para el Sheets API (USADA AQU√ç PARA LECTURA Y ESCRITURA)
        const SPREADSHEET_API_KEY = 'AIzaSyCooAsC52X4ccENCT6p3qh_82ErBxP47Lg'; 
        // ____________________________________________________________________
        
        let filaIndexExistente = null; 
        let datosCorteExistente = {}; 
        let nextCorte = 1;             
        let imagenVehiculoBase64 = null;
        let imagenCorte1Base64 = null;
        let imagenCorte2Base64 = null;
        let imagenCorte3Base64 = null;
        let imagenCablesBase64 = null;

        /* √çNDICES DE COLUMNA (0-based) para el manejo interno del CLIENTE:
        A: ID (Auto) (0)
        B: Categor√≠a (1)
        C: Colaborador (2)
        D: Marca (3)
        E: Modelo (4)
        F: A√±o (5)
        G: Tipo Encendido 1 (6)
        H: Tipo Corte 1 (7)
        I: Ubicaci√≥n Corte 1 (8) <- Columna de b√∫squeda
        J: Descripci√≥n Corte 1 (9)
        K: URL Imagen Corte 1 (10)
        ...
        V: Descripci√≥n Cables (21)
        W: URL Imagen Cables (22)
        X: URL Imagen Veh√≠culo (23)
        */
        
        // Columnas de b√∫squeda (Marca, Modelo, A√±o)
        const COL_MARCA = 3; // Columna D en Sheets
        const COL_MODELO = 4; // Columna E en Sheets
        const COL_ANIO = 5; // Columna F en Sheets

        // Columna de Ubicaci√≥n para buscar cortes existentes
        const COL_CORTE_1_UBICACION = 8; // Columna I
        const COL_CORTE_2_UBICACION = 13; // Columna N
        const COL_CORTE_3_UBICACION = 18; // Columna S


        // =============================================================
        // GESTI√ìN DE LA API DE GOOGLE SHEETS (LECTURA Y ESCRITURA)
        // =============================================================

        // Inicializa la librer√≠a de Google APIs (GAPI)
        function initClient() {
            gapi.client.init({
                apiKey: SPREADSHEET_API_KEY,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            }).then(function () {
                console.log("Google Sheets API Client Ready.");
            }, function(error) {
                console.error('Error loading Google Sheets API:', error);
                mostrarAlerta("Error al cargar la API de Google Sheets. Revisa la clave.", 'error');
            });
        }

        // Carga la API y llama a initClient
        gapi.load('client', initClient);


        // Funci√≥n de b√∫squeda para saber si el veh√≠culo ya existe
        async function buscarVehiculo() {
            const loading = document.getElementById("loading");
            const { marca, modelo, a√±o } = getCommonPayload();
            
            if (!marca || !modelo || !a√±o) {
                mostrarAlerta("Por favor, ingrese Marca, Modelo y A√±o.", 'error');
                return;
            }
            if (typeof gapi.client.sheets === 'undefined') {
                mostrarAlerta("API de Google Sheets no cargada correctamente.", 'error');
                return;
            }

            loading.style.display = "block";
            const range = 'Cortes!A:X'; // Rango amplio

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                });

                const values = response.result.values || [];
                let foundMatch = false;

                for (let i = 1; i < values.length; i++) { // Empezamos en la fila 2 (√≠ndice 1) para saltar encabezados
                    const row = values[i];
                    
                    // Compara Marca, Modelo, A√±o (usando los √≠ndices 0-based)
                    if (row[COL_MARCA] === marca && row[COL_MODELO] === modelo && Number(row[COL_ANIO]) === Number(a√±o)) {
                        
                        filaIndexExistente = i + 1; // Fila basada en 1 (para usar en update)
                        datosCorteExistente = {
                            corte1_ubicacion: row[COL_CORTE_1_UBICACION] || '',
                            corte2_ubicacion: row[COL_CORTE_2_UBICACION] || '',
                            corte3_ubicacion: row[COL_CORTE_3_UBICACION] || ''
                        };
                        foundMatch = true;
                        break;
                    }
                }

                loading.style.display = "none";

                if (foundMatch) {
                    if (!datosCorteExistente.corte1_ubicacion) { nextCorte = 1; }
                    else if (!datosCorteExistente.corte2_ubicacion) { nextCorte = 2; }
                    else if (!datosCorteExistente.corte3_ubicacion) { nextCorte = 3; }
                    else { nextCorte = 4; }

                    mostrarAlerta(`‚ö†Ô∏è Veh√≠culo ${marca} ${modelo} (${a√±o}) ya existe. Pr√≥ximo corte: ${nextCorte > 3 ? 'Lleno' : nextCorte}`, nextCorte > 3 ? 'error' : 'info');
                    
                    mostrarPaso(2, nextCorte > 3 ? 'full' : 'edit'); 

                } else {
                    filaIndexExistente = null;
                    datosCorteExistente = {};
                    nextCorte = 1;
                    mostrarAlerta("‚úÖ Veh√≠culo nuevo. Creando registro.", 'success');
                    mostrarPaso(2, 'new');
                }


            } catch (e) {
                loading.style.display = "none";
                mostrarAlerta("‚ùå Error al buscar en Sheets: " + e.message, 'error');
                console.error("Error en funci√≥n buscarVehiculo:", e);
            }
        }


        // =============================================================
        // GESTI√ìN DE ENV√çO (APPS SCRIPT + SHEETS API)
        // =============================================================
        async function enviar() {
            const loading = document.getElementById("loading");
            const commonPayload = getCommonPayload();

            // Recopilar datos del corte din√°mico (1, 2 o 3)
            const corteData = {
                tipoEncendido: document.getElementById(`tipoEncendido_${nextCorte}`).value,
                tipoCorte: document.getElementById(`tipoCorte_${nextCorte}`).value,
                ubicacion: document.getElementById(`ubicacion_${nextCorte}`).value.trim(),
                descripcion: document.getElementById(`descCorte_${nextCorte}`).value.trim(),
                imagenBase64: (nextCorte === 1) ? imagenCorte1Base64 : (nextCorte === 2) ? imagenCorte2Base64 : imagenCorte3Base64,
                corteNumero: nextCorte
            };

            if (!corteData.ubicacion) {
                mostrarAlerta("La 'Ubicaci√≥n Corte' es obligatoria.", 'error');
                return;
            }

            // Recopilar datos del Paso 3 (Cables)
            const cables = {
                descripcion: document.getElementById("descCables").value.trim(),
                imagenBase64: imagenCablesBase64
            };

            loading.style.display = "block";
            loading.innerText = "1/2: Subiendo im√°genes a Google Drive..."
            let imageUrls = {};

            try {
                // ==========================================================
                // PASO 1: ENVIAR IM√ÅGENES A APPS SCRIPT Y RECIBIR URLs
                // ==========================================================
                const imagePayload = {
                    categoria: commonPayload.categoria,
                    marca: commonPayload.marca,
                    modelo: commonPayload.modelo,
                    a√±o: commonPayload.a√±o,
                    // Solo enviar base64 si existe y es necesario
                    imagenVehiculo: imagenVehiculoBase64 ? { base64: imagenVehiculoBase64 } : null,
                    corte: corteData.imagenBase64 ? { imagen: corteData.imagenBase64, tipoCorte: corteData.tipoCorte } : null,
                    cables: cables.imagenBase64 ? { imagen: cables.imagenBase64 } : null
                };


                const res = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(imagePayload)
                });

                const jsonRes = await res.json();
                if (!jsonRes.success) {
                    throw new Error(jsonRes.error || jsonRes.message || "Error desconocido al subir archivos.");
                }
                imageUrls = jsonRes.urls || {};
                loading.innerText = "2/2: Escribiendo datos en Google Sheets..."


                // ==========================================================
                // PASO 2: ESCRIBIR DATOS (Incluyendo URLs) EN GOOGLE SHEETS API
                // ==========================================================
                
                let sheetRange;
                let values;
                let method = 'append'; // Por defecto para nuevos veh√≠culos

                // Determinar la columna de inicio para los 5 campos del corte (G=6, L=11, Q=16)
                let corteStartColIndex = (nextCorte === 1) ? 6 : (nextCorte === 2) ? 11 : 16;
                let corteStartColLetter = String.fromCharCode('A'.charCodeAt(0) + corteStartColIndex);
                
                if (filaIndexExistente === null) {
                    // A. CREAR NUEVA FILA (append)
                    
                    // Array de 24 elementos (B a X, √≠ndice 1 a 23)
                    // Nota: El √≠ndice 0 aqu√≠ es la columna B de la hoja (Categor√≠a)
                    values = new Array(23).fill(''); // Corregido: X es el √≠ndice 23 si B es el 0
                    
                    // Datos Comunes (B: Cat (0), C: Colab (1), D: Marca (2), E: Modelo (3), F: A√±o (4))
                    values[0] = commonPayload.categoria;     
                    values[1] = commonPayload.colaborador;   
                    values[2] = commonPayload.marca;         
                    values[3] = commonPayload.modelo;        
                    values[4] = commonPayload.a√±o;           

                    // Datos del Corte (5 columnas: Tipo Encendido(5), Tipo Corte(6), Ubicaci√≥n(7), Descripci√≥n(8), URL Imagen(9))
                    // El √≠ndice real en el array es 'ColumnaLetra' - 1. G es √≠ndice 6 en el array, no 6 en la columna B (que ser√≠a 5)
                    // Si el array empieza en B (columna 2), entonces B=0, C=1, D=2, E=3, F=4. G es 5.
                    // Ajustando √≠ndices para que B sea 0, C=1, ... F=4, G=5, H=6, I=7, J=8, K=9.
                    
                    // Si nextCorte es 1, corteStartColIndex = 6 (Columna G)
                    let arrayStartIndex = (nextCorte === 1) ? 5 : (nextCorte === 2) ? 10 : 15; // G=5, L=10, Q=15
                    
                    values[arrayStartIndex] = corteData.tipoEncendido;  
                    values[arrayStartIndex + 1] = corteData.tipoCorte;          
                    values[arrayStartIndex + 2] = corteData.ubicacion;      
                    values[arrayStartIndex + 3] = corteData.descripcion;    
                    values[arrayStartIndex + 4] = imageUrls.corte || '';    

                    // Datos de Cables/Apertura (V=20, W=21)
                    values[20] = cables.descripcion;         
                    values[21] = imageUrls.cables || '';     

                    // Imagen del Veh√≠culo (X=22)
                    values[22] = imageUrls.vehiculo || '';   

                    sheetRange = 'Cortes!B:X'; // El rango es B:X
                    method = 'append';
                    
                    // La API espera un array de valores, uno por cada columna en el rango.
                    const resourceAppend = {
                        spreadsheetId: SPREADSHEET_ID,
                        range: sheetRange,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [values] }
                    };
                    await gapi.client.sheets.spreadsheets.values[method](resourceAppend);


                } else {
                    // B. ACTUALIZAR FILA EXISTENTE (update)
                    method = 'update';
                    
                    const fila = filaIndexExistente;
                    
                    // 1. Actualizar Datos del Corte (5 columnas a la vez, G:K, L:P, o Q:U)
                    const corteEndColLetter = String.fromCharCode(corteStartColLetter.charCodeAt(0) + 4);
                    sheetRange = `Cortes!${corteStartColLetter}${fila}:${corteEndColLetter}${fila}`;
                    values = [
                        corteData.tipoEncendido,
                        corteData.tipoCorte,
                        corteData.ubicacion,
                        corteData.descripcion,
                        imageUrls.corte || '' 
                    ];

                    const resourceUpdateCorte = {
                        spreadsheetId: SPREADSHEET_ID,
                        range: sheetRange,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [values] }
                    };
                    await gapi.client.sheets.spreadsheets.values.update(resourceUpdateCorte);
                    
                    // 2. Actualizar Colaborador (Columna C)
                    const resourceUpdateColab = {
                        spreadsheetId: SPREADSHEET_ID,
                        range: `Cortes!C${fila}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [[commonPayload.colaborador]] }
                    };
                    await gapi.client.sheets.spreadsheets.values.update(resourceUpdateColab);

                    // 3. Actualizar Cables/Apertura (Columnas V:W)
                    const cablesValues = [cables.descripcion, imageUrls.cables || ''];
                    const resourceUpdateCables = {
                        spreadsheetId: SPREADSHEET_ID,
                        range: `Cortes!V${fila}:W${fila}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [cablesValues] }
                    };
                    await gapi.client.sheets.spreadsheets.values.update(resourceUpdateCables);

                    // 4. Actualizar Imagen Veh√≠culo (Columna X) si se subi√≥ una nueva
                    if (imageUrls.vehiculo) {
                        const resourceUpdateVehiculo = {
                            spreadsheetId: SPREADSHEET_ID,
                            range: `Cortes!X${fila}`,
                            valueInputOption: 'USER_ENTERED',
                            resource: { values: [[imageUrls.vehiculo]] }
                        };
                        await gapi.client.sheets.spreadsheets.values.update(resourceUpdateVehiculo);
                    }
                }
                
                loading.style.display = "none";
                mostrarAlerta("‚úÖ ¬°Guardado Correctamente! Recargando...", 'success');
                setTimeout(() => { location.reload(); }, 2000);


            } catch (e) {
                loading.style.display = "none";
                mostrarAlerta("‚ùå Error al guardar datos: " + e.message, 'error');
                console.error("Error en funci√≥n enviar:", e);
            }
        }

        // =============================================================
        // FUNCIONES COMUNES
        // =============================================================

        // Muestra una alerta flotante
        function mostrarAlerta(mensaje, tipo = 'info') {
            let alerta = document.getElementById('alerta');
            if (!alerta) {
                alerta = document.createElement('div');
                alerta.id = 'alerta';
                document.body.appendChild(alerta);
            }
            alerta.className = `alerta ${tipo}`;
            alerta.innerHTML = mensaje;
            
            // Muestra la alerta
            setTimeout(() => {
                alerta.classList.add('show');
            }, 50);

            // Oculta la alerta despu√©s de 4 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
            }, 4000);
        }

        // Convierte un archivo de input a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                // Eliminamos el prefijo 'data:image/...' para que Apps Script lo maneje.
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Prepara el payload con los campos comunes
        function getCommonPayload() {
            return {
                colaborador: document.getElementById("colaborador").value.trim(),
                categoria: document.getElementById("categoria").value,
                marca: document.getElementById("marca").value.trim(),
                modelo: document.getElementById("modelo").value.trim(),
                a√±o: Number(document.getElementById("a√±o").value),
            };
        }
        
        // Funci√≥n gen√©rica para manejar inputs de archivo
        function handleFileInput(event, base64VarName, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const label = event.target.nextElementSibling; // El label es el siguiente hermano

            if (file) {
                // Actualizar la etiqueta para mostrar el nombre del archivo
                label.textContent = `Archivo seleccionado: ${file.name}`;
                
                // Mostrar previsualizaci√≥n
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                // Convertir a Base64
                fileToBase64(file).then(base64 => {
                    // Usar eval para asignar la variable global. (No es ideal, pero funciona para variables din√°micas)
                    window[base64VarName] = base64;
                });
            } else {
                // Restaurar la etiqueta
                label.textContent = label.getAttribute('data-default-text');
                
                // Ocultar previsualizaci√≥n
                preview.src = '';
                preview.style.display = 'none';
                window[base64VarName] = null;
            }
        }

        // Maneja el input de archivo de veh√≠culo
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('imgVehiculo').addEventListener('change', function(event) {
                handleFileInput(event, 'imagenVehiculoBase64', 'previewVehiculo');
             });
             // Inicializar el texto por defecto en el label
             document.querySelector('label[for="imgVehiculo"]').setAttribute('data-default-text', 'Seleccionar Imagen del Veh√≠culo (Opcional)');
        });


        // =============================================================
        // PASO 2: DETALLES DEL CORTE (DIN√ÅMICO)
        // =============================================================

        // Prepara el contenido para el corte a agregar (1, 2 o 3)
        function prepararPaso2(mode) {
            const common = getCommonPayload();
            const titleEl = document.getElementById('step2-title');
            const corteContainer = document.getElementById('corte-dinamico-container');
            const nextBtn = document.getElementById('btn-siguiente-step2');
            const step2Header = document.getElementById('step2-header');


            // Limpiar listeners de archivos para evitar duplicados y resetear el contenido
            corteContainer.innerHTML = '';
            
            // Usar el bot√≥n de regresar del usuario
            step2Header.innerHTML = `<div class="backBtn" onclick="volverPaso(1)">&#9664; Regresar</div>`;
            titleEl.innerText = `Veh√≠culo: ${common.marca} ${common.modelo} (${common.a√±o})`;

            if (mode === 'full') {
                corteContainer.innerHTML = '<p class="text-red-600 font-semibold text-center mt-8">üö® El veh√≠culo ya tiene el n√∫mero m√°ximo de cortes (3) registrados.</p>';
                nextBtn.style.display = 'none';
                return;
            }
            
            // Mostrar los cortes existentes como referencia
            let infoExistente = '';
            if (datosCorteExistente.corte1_ubicacion) {
                infoExistente += `<p class="text-sm">Corte 1: ${datosCorteExistente.corte1_ubicacion}</p>`;
            }
            if (datosCorteExistente.corte2_ubicacion) {
                infoExistente += `<p class="text-sm">Corte 2: ${datosCorteExistente.corte2_ubicacion}</p>`;
            }
            if (datosCorteExistente.corte3_ubicacion) {
                infoExistente += `<p class="text-sm">Corte 3: ${datosCorteExistente.corte3_ubicacion}</p>`;
            }

            const cortesExistentesDiv = document.getElementById('cortes-existentes-info');
            cortesExistentesDiv.innerHTML = `<p class="font-bold mb-1">Cortes Existentes:</p>${infoExistente}`;
            cortesExistentesDiv.className = 'cortes-existentes-info'; // Aplicar el estilo definido
            cortesExistentesDiv.style.display = (infoExistente ? 'block' : 'none');


            // Generar el formulario para el nuevo corte (nextCorte)
            const base64Var = `imagenCorte${nextCorte}Base64`;
            const labelText = `Seleccionar Imagen Corte ${nextCorte}`;

            corteContainer.innerHTML = `
                <h3 class="text-lg font-bold mt-4 mb-3 border-b pb-1" style="color:#007bff;">Nuevo Corte ${nextCorte}</h3>

                <label for="tipoEncendido_${nextCorte}">Tipo de Encendido (Solo si es Corte 1)</label>
                <select id="tipoEncendido_${nextCorte}">
                    <option value="No aplica" ${nextCorte > 1 ? 'selected' : ''}>No aplica</option>
                    <option value="Ignici√≥n">Ignici√≥n</option>
                    <option value="Bomba de combustible">Bomba de combustible</option>
                    <option value="Se√±al a bot√≥n">Se√±al a bot√≥n</option>
                    <option value="Se√±al a ahogador">Se√±al a ahogador</option>
                </select>

                <label for="tipoCorte_${nextCorte}">Tipo de Corte ${nextCorte}</label>
                <select id="tipoCorte_${nextCorte}">
                    <option value="No recomendado">No recomendado</option>
                    <option value="Ignici√≥n">Ignici√≥n</option>
                    <option value="Bomba de combustible">Bomba de combustible</option>
                    <option value="Se√±al a bot√≥n">Se√±al a bot√≥n</option>
                    <option value="Se√±al a ahogador">Se√±al a ahogador</option>
                </select>

                <label for="ubicacion_${nextCorte}">Ubicaci√≥n Corte ${nextCorte}</label>
                <input type="text" id="ubicacion_${nextCorte}" placeholder="Ej: Detr√°s de la guantera, pin 5" required>

                <label for="descCorte_${nextCorte}">Descripci√≥n Corte ${nextCorte}</label>
                <textarea id="descCorte_${nextCorte}" placeholder="Detalles de c√≥mo realizar el corte"></textarea>

                <label for="imgCorte_${nextCorte}">Imagen Corte ${nextCorte}</label>
                
                <!-- INPUT DE ARCHIVO OCULTO -->
                <input type="file" id="imgCorte_${nextCorte}" class="input-file-hidden" accept="image/*">
                <!-- LABEL ESTILIZADO -->
                <label for="imgCorte_${nextCorte}" class="custom-file-upload" data-default-text="${labelText}">${labelText}</label>
                <!-- PREVISUALIZACI√ìN -->
                <img id="previewCorte_${nextCorte}" class="image-preview" style="display:none;" alt="Previsualizaci√≥n del corte ${nextCorte}">
            `;

            // A√±adir el listener de archivo para el corte din√°mico
            document.getElementById(`imgCorte_${nextCorte}`).addEventListener('change', (e) => {
                handleFileInput(e, base64Var, `previewCorte_${nextCorte}`);
            });
            // Inicializar el texto por defecto en el label
            document.querySelector(`label[for="imgCorte_${nextCorte}"]`).setAttribute('data-default-text', labelText);


            // Deshabilitar la opci√≥n de Encendido si no es Corte 1
            if (nextCorte > 1) {
                document.getElementById(`tipoEncendido_${nextCorte}`).setAttribute('disabled', 'true');
            }

            nextBtn.style.display = 'block';
        }


        // =============================================================
        // PASO 3: DETALLES ADICIONALES (CABLES)
        // =============================================================
        
        // Event listener para convertir imagen de cables a base64
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('imgCables').addEventListener('change', (e) => {
                handleFileInput(e, 'imagenCablesBase64', 'previewCables');
            });
             // Inicializar el texto por defecto en el label
             document.querySelector('label[for="imgCables"]').setAttribute('data-default-text', 'Seleccionar Imagen de la Conexi√≥n o Apertura');
        });

        // =============================================================
        // NAVEGACI√ìN
        // =============================================================

        function volverPaso(n) {
            document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
            document.getElementById("step" + n).classList.add("active");
        }

        function mostrarPaso(n, mode = 'new') {
            document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
            document.getElementById("step" + n).classList.add("active");

            if (n === 2) {
                prepararPaso2(mode);
            }
        }

        // Inicializar: mostrar el primer paso
        document.addEventListener("DOMContentLoaded", () => {
            mostrarPaso(1);
        });
        </script>
        
        
        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 1 (B√öSQUEDA) -->
        <!-- ============================================================= -->
        <div id="step1" class="step active">
            <h2 class="text-xl font-bold mb-4 text-gray-700">1. Datos del Veh√≠culo</h2>

            <label for="colaborador">Colaborador</label>
            <input type="text" id="colaborador" placeholder="Tu nombre" required>

            <label for="categoria">Categor√≠a</label>
            <select id="categoria">
                <option value="Carro">Carro</option>
                <option value="Cami√≥n">Cami√≥n</option>
                <option value="Moto">Moto</option>
                <option value="Construcci√≥n">Construcci√≥n</option>
            </select>
            
            <label for="marca">Marca</label>
            <input type="text" id="marca" placeholder="Ej: Toyota" required>
            
            <label for="modelo">Modelo</label>
            <input type="text" id="modelo" placeholder="Ej: Corolla" required>
            
            <label for="a√±o">A√±o</label>
            <input type="number" id="a√±o" placeholder="Ej: 2020" min="1900" max="2100" required>
            
            <label for="imgVehiculo" class="text-sm text-gray-500">Imagen del Veh√≠culo (Solo para veh√≠culos nuevos)</label>
            
            <!-- INPUT DE ARCHIVO OCULTO -->
            <input type="file" id="imgVehiculo" class="input-file-hidden" accept="image/*">
            <!-- LABEL ESTILIZADO -->
            <label for="imgVehiculo" class="custom-file-upload" data-default-text="Seleccionar Imagen del Veh√≠culo (Opcional)">Seleccionar Imagen del Veh√≠culo (Opcional)</label>
            <!-- PREVISUALIZACI√ìN -->
            <img id="previewVehiculo" class="image-preview" style="display:none;" alt="Previsualizaci√≥n del veh√≠culo">

            <button class="btn mt-6" onclick="buscarVehiculo()">
                Continuar y Buscar Veh√≠culo
            </button>

            <div id="loading" class="loading">Cargando...</div>
        </div>
        
        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 2 (CORTE DIN√ÅMICO) -->
        <!-- ============================================================= -->
        <div id="step2" class="step">
            <div id="step2-header">
                <div class="backBtn" onclick="volverPaso(1)">&#9664; Regresar</div>
            </div>
            <h2 id="step2-title" class="text-xl font-semibold mb-2 text-gray-700"></h2>
            
            <div id="cortes-existentes-info" style="display:none;">
                <!-- Cortes Existentes se insertan aqu√≠ -->
            </div>

            <div id="corte-dinamico-container">
                <!-- El formulario del Corte 1/2/3 se generar√° aqu√≠ por JavaScript -->
            </div>

            <div class="flex gap-4 mt-6" style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: 50%;" onclick="volverPaso(1)">Regresar</button>
                <button id="btn-siguiente-step2" class="btn" style="width: 50%;" onclick="mostrarPaso(3)">Siguiente</button>
            </div>
        </div>

        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 3 (CABLES) -->
        <!-- ============================================================= -->
        <div id="step3" class="step">
            <div class="backBtn" onclick="mostrarPaso(2)">&#9664; Regresar</div>
            <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Detalles de Cables/Apertura</h2>

            <label for="descCables">Descripci√≥n de Cables/Conexi√≥n/Apertura</label>
            <textarea id="descCables" placeholder="Descripci√≥n detallada de la conexi√≥n de cables, color, o apertura."></textarea>

            <label for="imgCables">Imagen de la Conexi√≥n o Apertura</label>
            
            <!-- INPUT DE ARCHIVO OCULTO -->
            <input type="file" id="imgCables" class="input-file-hidden" accept="image/*">
            <!-- LABEL ESTILIZADO -->
            <label for="imgCables" class="custom-file-upload" data-default-text="Seleccionar Imagen de la Conexi√≥n o Apertura">Seleccionar Imagen de la Conexi√≥n o Apertura</label>
            <!-- PREVISUALIZACI√ìN -->
            <img id="previewCables" class="image-preview" style="display:none;" alt="Previsualizaci√≥n de cables">

            <div class="flex gap-4 mt-6" style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: 50%;" onclick="mostrarPaso(2)">Regresar</button>
                <button class="btn" style="width: 50%;" onclick="enviar()">Guardar Corte</button>
            </div>
        </div>
    </div>
</div>

<!-- FOOTER PROPORCIONADO POR EL USUARIO -->
<footer class="footer">
    Gpspedia 2025¬© todos los derechos reservados.
</footer>
</body>
</html>
