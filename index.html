<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agregar Corte de Vehículo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        padding: 20px;
        background: #f0f4f8;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
    }

    .container {
        width: 100%;
        max-width: 500px;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .step {
        display: none;
    }

    .step.active {
        display: block;
    }

    /* Estilos de Formulario */
    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    input[type="text"], input[type="number"], select, textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
        border-color: #007bff;
        outline: none;
    }

    .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        margin-top: 20px;
        transition: background-color 0.3s;
    }

    .btn:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        margin-top: 10px;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .loading {
        display: none;
        font-size: 18px;
        margin-top: 10px;
        text-align: center;
        color: #007bff;
    }

    .image-preview {
        width: 100%;
        height: 150px;
        object-fit: cover;
        margin-top: 10px;
        display: none;
        border-radius: 6px;
        border: 1px solid #ddd;
    }

    .opcion {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        cursor: pointer;
        border: 2px solid #e9ecef;
        transition: all 0.2s;
        font-weight: 500;
    }

    .opcion:hover {
        background: #d1e7fd;
        border-color: #007bff;
    }

    .alert-box {
        padding: 15px;
        margin-top: 15px;
        border-radius: 8px;
        font-weight: bold;
        display: none;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

</style>
</head>

<body>

<div class="container">
    <h2>Ingreso de Soluciones para Vehículos</h2>

    <div id="loading" class="loading">⏳ Procesando, espera un momento...</div>
    <div id="alertBox" class="alert-box"></div>

    <!-- PASO 1: DATOS BÁSICOS Y FILTRO -->
    <div id="step1" class="step active">
        <h3>1. Datos de Identificación</h3>

        <label for="colaborador">Colaborador</label>
        <input type="text" id="colaborador" required>

        <label for="categoria">Categoría (Tipo de vehículo)</label>
        <select id="categoria" required></select>

        <label for="marca">Marca</label>
        <input type="text" id="marca" required>

        <label for="modelo">Modelo</label>
        <input type="text" id="modelo" required>

        <label for="anio">Año (Generación)</label>
        <input type="number" id="anio" required>

        <label for="imagenVehiculo">Imagen del vehículo</label>
        <input type="file" id="imagenVehiculo" accept="image/*" onchange="manejarFileChange('imagenVehiculo', 'previewVehiculo')">
        <img id="previewVehiculo" class="image-preview">

        <button class="btn" onclick="validarModelo()">Buscar y Continuar</button>
    </div>


    <!-- PASO 2: SELECCIÓN DE ACCIÓN (Si el modelo existe) -->
    <div id="step2" class="step">
        <h3>2. Modelo Encontrado</h3>
        <p id="infoExistente">El modelo <strong id="modeloEncontrado"></strong> ya está registrado.</p>

        <h4>¿Qué deseas agregar o actualizar?</h4>

        <div id="opciones">
            <!-- Las opciones se generan aquí dinámicamente -->
        </div>

        <button class="btn-secondary" onclick="volverPaso(1)">Regresar a Búsqueda</button>
    </div>


    <!-- PASO 3: FORMULARIO DINÁMICO (Nuevo Modelo o Agregar Dato) -->
    <div id="step3" class="step">
        <h3 id="tituloStep3"></h3>

        <div id="contenidoStep3">
            <!-- El formulario se genera aquí dinámicamente -->
        </div>

        <button class="btn" onclick="enviar()">Enviar y Guardar</button>
        <button class="btn-secondary" onclick="volverPaso(2)">Regresar a Opciones</button>
    </div>
</div>


<script>
// **IMPORTANTE**: Reemplaza esta URL con el endpoint de tu Web App de Google Apps Script.
// Asegúrate de que esta URL esté correctamente actualizada.
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyHWviOzHjb5qsKCHBhscXzoyH4iM5S2jRNJl_NbaOsw5E4nQdwUQKw307LZewYd5wX/exec'; 

let datosExistentes = null;
let listasValidacion = {
    categorias: [],
    tipoEncendido: [],
    tipoCorte: []
}; 
let accionSeleccionada = "";
let fileData = {}; // Para guardar {nombreCampo: {base64: '...', name: '...'}, ...}


// =============================================================
// UTILIDADES: Carga, Alertas, y Cambio de Archivos
// =============================================================

// Función para mostrar alertas (reemplaza alert())
function mostrarAlerta(mensaje, tipo) {
    const alertBox = document.getElementById("alertBox");
    alertBox.innerText = mensaje;
    alertBox.className = "alert-box";
    alertBox.classList.add(tipo === 'error' ? 'alert-error' : 'alert-success');
    alertBox.style.display = 'block';
    setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
}

// Función para manejar la previsualización y conversión a Base64
function manejarFileChange(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    const file = input.files[0];

    if (!file) {
        fileData[inputId] = null;
        preview.style.display = "none";
        preview.src = "";
        return;
    }

    // Validación de tamaño (opcional, 5MB máximo)
    if (file.size > 5 * 1024 * 1024) {
        mostrarAlerta("La imagen es demasiado grande. Máximo 5MB.", 'error');
        input.value = ''; // Limpiar el input file
        preview.style.display = "none";
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
        // Solo guardar la data base64 limpia, el Apps Script maneja la detección de mime
        const base64Content = e.target.result;
        // La expresión regular es robusta para eliminar el prefijo
        const base64Data = base64Content.replace(/^data:image\/[a-zA-Z0-9.+-]+;base64,/, ""); 
        
        fileData[inputId] = {
            base64: base64Data, 
            name: file.name
        };
        preview.src = e.target.result;
        preview.style.display = "block";
    };
    reader.readAsDataURL(file);
}

// Inicialización: Cargar listas de validación usando FETCH
window.onload = async () => {
    const loading = document.getElementById("loading");
    loading.style.display = "block";

    try {
        const url = `${WEB_APP_URL}?action=getValidationData`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();

        listasValidacion = data;
        const catSelect = document.getElementById("categoria");
        listasValidacion.categorias.forEach(c => {
            let op = document.createElement("option");
            op.value = c;
            op.innerText = c;
            catSelect.appendChild(op);
        });
        loading.style.display = "none";

    } catch (error) {
        loading.style.display = "none";
        mostrarAlerta("Error al cargar las listas de validación. Asegúrate que la WEB_APP_URL es correcta y está desplegada. Detalle: " + error.message, 'error');
        console.error("Error de carga inicial:", error);
    }
};


// =============================================================
// FLUJO DE FASES
// =============================================================

// Paso 1: Búsqueda y Validación de Modelo
async function validarModelo() {
    // Recolectar datos del Paso 1
    const colaborador = document.getElementById("colaborador").value.trim();
    const categoria = document.getElementById("categoria").value;
    const marca = document.getElementById("marca").value.trim();
    const modelo = document.getElementById("modelo").value.trim();
    const anio = document.getElementById("anio").value.trim();
    
    if (!colaborador || !categoria || !marca || !modelo || !anio) {
        mostrarAlerta("Por favor, llena todos los campos obligatorios del Paso 1.", 'error');
        return;
    }
    
    // Si no se ha cargado una imagen del vehículo
    if (!fileData.imagenVehiculo && document.getElementById("step1").classList.contains("active")) {
        mostrarAlerta("La Imagen del vehículo es obligatoria para el registro/actualización.", 'error');
        return;
    }

    const loading = document.getElementById("loading");
    loading.style.display = "block";

    const params = new URLSearchParams({ 
        action: 'buscarModelo', 
        categoria: categoria, 
        marca: marca, 
        modelo: modelo, 
        anio: anio 
    });
    
    // Usamos el método GET para la búsqueda. Esto no debería dar problemas de CORS.
    const url = `${WEB_APP_URL}?${params.toString()}`;

    try {
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - Respuesta: ${await response.text()}`);
        }
        
        const data = await response.json();
        datosExistentes = data;
        loading.style.display = "none";

        if (datosExistentes.existe === false) {
            // No existe: Registrar modelo nuevo
            accionSeleccionada = "nuevoModelo";
            generarFormularioModeloNuevo();
            volverPaso(3);

        } else {
            // Sí existe: Mostrar opciones de actualización
            document.getElementById("modeloEncontrado").innerText = `${marca} ${modelo} (${anio})`;
            mostrarOpcionesExistentes(datosExistentes);
            volverPaso(2);
        }
    } catch(error) {
        loading.style.display = "none";
        mostrarAlerta("Error al validar el modelo. Verifica tu URL de despliegue. Detalle: " + error.message, 'error');
        console.error("Error de validación de modelo:", error);
    }
}

// Paso 2: Mostrar opciones para modelo existente
function mostrarOpcionesExistentes(info) {
    const opcionesDiv = document.getElementById("opciones");
    opcionesDiv.innerHTML = "";

    // Corte faltante
    if (!info.tieneCorte1 || !info.tieneCorte2 || !info.tieneCorte3) {
        let div = crearOpcion("Agregar Corte " + (info.tieneCorte1 ? (info.tieneCorte2 ? '3' : '2') : '1'), 'corteNuevo');
        opcionesDiv.appendChild(div);
    }

    // Apertura faltante
    if (!info.tieneApertura) {
        opcionesDiv.appendChild(crearOpcion("Agregar Apertura", 'apertura'));
    }

    // Cables de Alimentación faltantes
    if (!info.tieneCables) {
        opcionesDiv.appendChild(crearOpcion("Agregar Cables de Alimentación", 'cables'));
    }

    // Imagen Vehículo
    if (!info.tieneImagenVehiculo) {
        opcionesDiv.appendChild(crearOpcion("Actualizar Imagen del Vehículo", 'imagenVehiculoUpdate'));
    }
    
    // Otras opciones de actualización
    opcionesDiv.appendChild(crearOpcion("Actualizar Nota Importante", 'nota'));
    opcionesDiv.appendChild(crearOpcion("Actualizar Cómo Desarmar Plásticos", 'plasticos'));
}

function crearOpcion(texto, accion) {
    let div = document.createElement("div");
    div.className = "opcion";
    div.innerText = texto;
    div.onclick = () => {
        // Al hacer clic, se inicia la acción
        accionSeleccionada = accion;
        document.getElementById("step3").scrollIntoView(); // Scroll para mejor UX
        generarFormularioDinamico(accion);
        volverPaso(3);
    };
    return div;
}

// =============================================================
// GENERACIÓN DE FORMULARIOS DINÁMICOS
// =============================================================

function generarSelect(id, label, opciones) {
    opciones = Array.isArray(opciones) ? opciones : [];

    let html = `<label for="${id}">${label}</label><select id="${id}" required>`;
    html += `<option value="">Selecciona una opción</option>`;
    opciones.forEach(op => {
        let selected = (id === 'tipoCorte' && op === 'No recomendado') ? 'selected' : '';
        html += `<option value="${op}" ${selected}>${op}</option>`;
    });
    html += `</select>`;
    return html;
}

function generarInputFile(id, label, previewId, required = true) {
    const requiredAttr = required ? 'required' : '';
    return `
        <label for="${id}">${label}</label>
        <input type="file" id="${id}" accept="image/*" onchange="manejarFileChange('${id}', '${previewId}')" ${requiredAttr}>
        <img id="${previewId}" class="image-preview">
    `;
}

function generarFormularioModeloNuevo() {
    const contenido = document.getElementById("contenidoStep3");
    const tipoEncendidoSelect = generarSelect('tipoEncendido', 'Tipo de encendido (Validación)', listasValidacion.tipoEncendido);
    const tipoCorteSelect = generarSelect('tipoCorte', 'Tipo de corte (Validación)', listasValidacion.tipoCorte);
    
    // Para el nuevo modelo, la imagen del vehículo ya se capturó en el Paso 1.
    contenido.innerHTML = `
        ${tipoEncendidoSelect}
        <label for="comoDesarmarPlasticos">Cómo desarmar los plásticos (Opcional)</label>
        <textarea id="comoDesarmarPlasticos" rows="3"></textarea>
        <hr style="margin: 20px 0;">
        <h4>Corte Inicial (Corte 1)</h4>
        ${tipoCorteSelect}
        <label for="descCorte1">Descripción del corte</label>
        <textarea id="descCorte1" rows="3" required></textarea>
        ${generarInputFile('imgCorte1', 'Imagen del Corte 1', 'previewCorte1')}
    `;
    document.getElementById("tituloStep3").innerText = "3. Registrar Modelo Nuevo";
}


function generarFormularioDinamico(accion) {
    const contenido = document.getElementById("contenidoStep3");
    let html = "";
    let titulo = "";

    // Opciones para los selects de validación
    const tipoCorteSelect = generarSelect('tipoCorte', 'Tipo de corte (Validación)', listasValidacion.tipoCorte);

    switch (accion) {
        case 'corteNuevo':
            titulo = "3. Agregar Corte Adicional";
            html = `
                ${tipoCorteSelect}
                <label for="descripcionCorte">Descripción del corte</label>
                <textarea id="descripcionCorte" rows="3" required></textarea>
                ${generarInputFile('imgCorte', 'Imagen del Corte', 'previewCorte')}
            `;
            break;

        case 'apertura':
            titulo = "3. Agregar Apertura";
            html = `
                <label for="descApertura">Apertura (Descripción)</label>
                <textarea id="descApertura" rows="3" required></textarea>
                ${generarInputFile('imgApertura', 'Imagen de la Apertura', 'previewApertura')}
            `;
            break;

        case 'cables':
            titulo = "3. Agregar Cables de Alimentación";
            html = `
                <label for="descCables">Cables de Alimentación (Descripción)</label>
                <textarea id="descCables" rows="3" required></textarea>
                ${generarInputFile('imgCables', 'Imagen de los Cables de Alimentación', 'previewCables')}
            `;
            break;

        case 'plasticos':
            titulo = "3. Actualizar Cómo Desarmar Plásticos";
            html = `
                <label for="comoDesarmarPlasticos">Cómo desarmar los plásticos</label>
                <textarea id="comoDesarmarPlasticos" rows="3" required></textarea>
            `;
            break;

        case 'nota':
            titulo = "3. Actualizar Nota Importante";
            html = `
                <label for="notaImportante">Nota Importante</label>
                <textarea id="notaImportante" rows="3" required></textarea>
            `;
            break;
            
        case 'imagenVehiculoUpdate':
            titulo = "3. Actualizar Imagen del Vehículo";
            html = `
                <p>La imagen anterior se reemplazará.</p>
                ${generarInputFile('imagenVehiculoUpdateFile', 'Nueva Imagen del Vehículo', 'previewVehiculoUpdate')}
            `;
            // Asegurarse de que la imagen del Paso 1 no se envíe si solo estamos actualizando la imagen del vehículo.
            delete fileData.imagenVehiculo; 
            break;

        default:
            html = "<p>Acción de formulario no válida.</p>";
            break;
    }

    document.getElementById("tituloStep3").innerText = titulo;
    contenido.innerHTML = html;
}

// =============================================================
// ENVÍO DE DATOS
// =============================================================

async function enviar() {
    const loading = document.getElementById("loading");
    loading.style.display = "block";

    // Recolectar datos del Paso 1 (son la base de cualquier envío)
    const basePayload = {
        colaborador: document.getElementById("colaborador").value.trim(),
        categoria: document.getElementById("categoria").value,
        marca: document.getElementById("marca").value.trim(),
        modelo: document.getElementById("modelo").value.trim(),
        anio: Number(document.getElementById("anio").value),
        accion: accionSeleccionada,
        // Si el modelo existe, usamos el índice de fila que vino en la búsqueda
        rowIndex: datosExistentes?.rowIndex || null 
    };

    let finalPayload = {};

    try {
        // Validación general de datos base
        if (!basePayload.colaborador || !basePayload.categoria || !basePayload.marca || !basePayload.modelo || !basePayload.anio) {
             throw new Error("Faltan datos de identificación obligatorios (Colaborador, Categoría, Marca, Modelo, Año).");
        }
        
        // La imagen del vehículo se re-evalúa al momento del envío para casos de "imagenVehiculoUpdate"
        let currentImagenVehiculo = fileData.imagenVehiculo;

        switch (accionSeleccionada) {
            case 'nuevoModelo':
                const tipoEncendido = document.getElementById('tipoEncendido').value;
                const tipoCorte1 = document.getElementById('tipoCorte').value;
                const descCorte1 = document.getElementById('descCorte1').value.trim();
                
                if (!tipoEncendido || !tipoCorte1 || !descCorte1 || !fileData.imgCorte1 || !currentImagenVehiculo) {
                    throw new Error("Faltan datos o la Imagen del Vehículo y la Imagen del Corte 1 son obligatorias para un NUEVO modelo.");
                }

                finalPayload = {
                    ...basePayload,
                    tipoEncendido: tipoEncendido,
                    comoDesarmarPlasticos: document.getElementById('comoDesarmarPlasticos').value.trim(),
                    imagenVehiculo: currentImagenVehiculo, 
                    corte1: {
                        tipoCorte: tipoCorte1,
                        descripcion: descCorte1,
                        imagen: fileData.imgCorte1
                    }
                };
                break;

            case 'corteNuevo':
                const tipoCorte = document.getElementById('tipoCorte').value;
                const descripcionCorte = document.getElementById('descripcionCorte').value.trim();
                if (!tipoCorte || !descripcionCorte || !fileData.imgCorte) {
                    throw new Error("Faltan datos o la imagen del Corte es obligatoria.");
                }

                finalPayload = {
                    ...basePayload,
                    corte: {
                        tipoCorte: tipoCorte,
                        descripcion: descripcionCorte,
                        imagen: fileData.imgCorte
                    }
                };
                break;

            case 'apertura':
                const descApertura = document.getElementById('descApertura').value.trim();
                if (!descApertura || !fileData.imgApertura) {
                    throw new Error("Faltan datos o la imagen de la Apertura es obligatoria.");
                }

                finalPayload = {
                    ...basePayload,
                    apertura: {
                        descripcion: descApertura,
                        imagen: fileData.imgApertura
                    }
                };
                break;

            case 'cables':
                const descCables = document.getElementById('descCables').value.trim();
                if (!descCables || !fileData.imgCables) {
                    throw new Error("Faltan datos o la imagen de los Cables es obligatoria.");
                }

                finalPayload = {
                    ...basePayload,
                    cables: {
                        descripcion: descCables,
                        imagen: fileData.imgCables
                    }
                };
                break;
                
            case 'imagenVehiculoUpdate':
                if (!fileData.imagenVehiculoUpdateFile) {
                    throw new Error("La nueva imagen del vehículo es obligatoria para actualizar.");
                }
                 finalPayload = {
                    ...basePayload,
                    imagenVehiculo: fileData.imagenVehiculoUpdateFile
                };
                break;

            case 'plasticos':
                finalPayload = {
                    ...basePayload,
                    comoDesarmarPlasticos: document.getElementById('comoDesarmarPlasticos').value.trim()
                };
                break;

            case 'nota':
                finalPayload = {
                    ...basePayload,
                    notaImportante: document.getElementById('notaImportante').value.trim()
                };
                break;

            default:
                throw new Error("Acción de formulario no válida.");
        }
        
        // Ejecutar el fetch a doPost
        const res = await fetch(WEB_APP_URL, {
            method: "POST",
            // *** CORRECCIÓN CRÍTICA PARA CORS ***
            // Se elimina el encabezado Content-Type para que el navegador envíe 
            // la solicitud como "simple" y evite el preflight de CORS.
            body: JSON.stringify(finalPayload)
        });

        const jsonRes = await res.json();
        loading.style.display = "none";

        if (jsonRes.success) {
            mostrarAlerta("✅ ¡Guardado Correctamente! Recargando...", 'success');
            // Recargar después de un breve delay para que el usuario lea el mensaje
            setTimeout(() => { location.reload(); }, 2000);
        } else {
            throw new Error(jsonRes.error || "Error desconocido al guardar en Apps Script.");
        }

    } catch (e) {
        loading.style.display = "none";
        // Si el error es TypeError: Failed to fetch, es probablemente que el CORS aún está bloqueando.
        if (e.message.includes("Failed to fetch")) {
            mostrarAlerta("❌ Error de Conexión. Posiblemente un bloqueo de CORS. Revisa la consola para más detalles. Asegúrate de que el despliegue del Apps Script esté configurado para 'Cualquier persona' (Anyone).", 'error');
        } else {
            mostrarAlerta("❌ Error de envío: " + e.message, 'error');
        }
        console.error("Error en función enviar:", e);
    }
}


// =============================================================
// NAVEGACIÓN
// =============================================================

function volverPaso(n) {
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    document.getElementById("step" + n).classList.add("active");

    // Lógica para el botón de Regresar en el Paso 3
    const btnRegresar = document.querySelector("#step3 .btn-secondary");
    if (btnRegresar) {
        // Si datosExistentes es null, volvemos al paso 1 (Búsqueda). Si no, volvemos al paso 2 (Opciones).
        btnRegresar.onclick = () => volverPaso(datosExistentes?.existe ? 2 : 1);
    }
}
</script>

</body>
</html>
