<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GPSpedia — Agregar / Actualizar Corte (Multi-paso)</title>
<style>
:root{--accent:#007bff;--accent-dark:#0056b3}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f4f4;color:#222}
.container{max-width:900px;margin:18px auto;padding:16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.app-logo{width:84px;height:auto;border-radius:8px}
.title{font-size:1.6rem;margin:0}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.06)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:150px}
label{display:block;font-weight:700;margin-top:10px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:0.95rem}
textarea{min-height:90px;resize:vertical}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
button.alt{background:#f0f0f0;color:#222;border:1px solid #ddd}
.small{padding:8px;font-size:0.9rem;border-radius:8px}
.step-indicator{display:flex;gap:8px;margin-bottom:12px}
.step-pill{padding:6px 10px;border-radius:999px;background:#eee;font-weight:700;color:#444}
.hidden{display:none}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;border-radius:12px;padding:16px;max-width:740px;width:92%;max-height:86vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,0.25)}
.modal img{max-width:220px;border-radius:8px;margin-top:8px}

/* previews */
.preview{display:block;margin-top:8px;max-width:260px;border-radius:8px}
.preview-sm{max-width:120px}

/* cortes */
.corte{background:#fbfbfb;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:10px}

/* loading */
.loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.75);z-index:10000;display:none}
.spinner{width:64px;height:64px;border-radius:50%;border:8px solid rgba(0,0,0,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* responsive */
@media (max-width:520px){ .row{flex-direction:column} .title{font-size:1.2rem} .preview{max-width:95%} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <img class="app-logo" src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="GPSpedia">
    <div>
      <h1 class="title">GPSpedia — Agregar / Actualizar</h1>
      <small>Formulario paso a paso — evita duplicados y sube imágenes a Drive</small>
    </div>
  </div>

  <div class="card">
    <div class="step-indicator">
      <div class="step-pill">Paso 1 • Identificar</div>
      <div class="step-pill">Paso 2 • Opciones</div>
      <div class="step-pill">Paso 3 • Datos</div>
    </div>

    <!-- STEP 1 -->
    <div id="step1">
      <label>Nombre del colaborador</label>
      <input id="colaborador" placeholder="Ej. Pablo Peña" required>

      <div class="row">
        <div class="col">
          <label>Categoría</label>
          <select id="categoria"></select>
        </div>
        <div class="col">
          <label>Tipo de encendido</label>
          <select id="tipoEncendido"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Marca</label>
          <input id="marca" autocomplete="off" placeholder="Ej. Audi">
        </div>
        <div class="col">
          <label>Modelo</label>
          <input id="modelo" autocomplete="off" placeholder="Ej. A1">
        </div>
        <div class="col" style="min-width:120px">
          <label>Año (ej. 2015)</label>
          <input id="año" type="number" min="1900" max="2099" placeholder="2015">
        </div>
      </div>

      <label>Imagen del vehículo (opcional)</label>
      <input id="imagenVehiculo" type="file" accept="image/*">
      <img id="previewVehiculo" class="preview" style="display:none">

      <div style="display:flex;gap:8px;margin-top:14px">
        <button id="btnStep1Next" class="small">Buscar / Siguiente</button>
        <button id="btnReset" class="small alt">Limpiar</button>
        <div id="inlineMsg" style="align-self:center;color:#666;margin-left:8px"></div>
      </div>
    </div>

    <!-- STEP 2: opciones según coincidencia -->
    <div id="step2" class="hidden" style="margin-top:14px">
      <div id="foundCard" class="card" style="margin-bottom:12px"></div>

      <div class="card">
        <p><strong>¿Qué deseas hacer?</strong></p>
        <div id="optionsBtns" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <div style="margin-top:12px">
          <button id="btnCreateNew" class="small">Crear nueva fila / generación</button>
          <button id="btnBackTo1" class="small alt">Volver</button>
        </div>
      </div>
    </div>

    <!-- STEP 3: formulario parcial (según elección) -->
    <div id="step3" class="hidden" style="margin-top:14px">
      <div id="formTitle"><h3>Agregar información</h3></div>

      <!-- Cortes -->
      <div id="formCortes" class="card hidden">
        <label>Agregar cortes (máx 3)</label>
        <div id="cortesList">
          <!-- primer corte por defecto -->
          <div class="corte">
            <label>Tipo de corte</label>
            <select class="tipoCorte"></select>
            <label>Descripción</label>
            <textarea class="descCorte"></textarea>
            <label>Imagen (opcional)</label>
            <input type="file" class="imgCorte" accept="image/*">
            <img class="preview cortePreview" style="display:none">
            <div style="margin-top:8px"><button type="button" class="removeCorteBtn small alt" style="display:none">Eliminar</button></div>
          </div>
        </div>
        <div style="margin-top:8px"><button id="addCorteBtn" class="small">Agregar otro corte</button></div>
      </div>

      <!-- Apertura -->
      <div id="formApertura" class="card hidden" style="margin-top:10px">
        <label>Apertura (si aplica)</label>
        <label>Descripción</label>
        <textarea id="aperturaDesc"></textarea>
        <label>Imagen (opcional)</label>
        <input id="aperturaImg" type="file" accept="image/*">
        <img id="previewApertura" class="preview" style="display:none">
      </div>

      <!-- Cables -->
      <div id="formCables" class="card hidden" style="margin-top:10px">
        <label>Cables de alimentación (si aplica)</label>
        <label>Descripción</label>
        <textarea id="cablesDesc"></textarea>
        <label>Imagen (opcional)</label>
        <input id="cablesImg" type="file" accept="image/*">
        <img id="previewCables" class="preview" style="display:none">
      </div>

      <!-- Nota y plasticos -->
      <div id="formOther" class="card" style="margin-top:10px">
        <label>Nota importante</label>
        <textarea id="nota"></textarea>
        <label>Cómo desarmar los plásticos</label>
        <textarea id="plasticos"></textarea>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnSubmit" class="small">Enviar</button>
        <button id="btnBackTo2" class="small alt">Volver</button>
      </div>
    </div>

  </div>
</div>

<!-- modal genérico -->
<div id="modalBackdrop" class="modal-backdrop hidden" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <div id="modalBody"></div>
    <div style="margin-top:12px" id="modalActions"></div>
  </div>
</div>

<!-- loading -->
<div id="loading" class="loading"><div><div class="spinner"></div><div style="margin-top:10px;font-weight:700;color:#333">Procesando…</div></div></div>

<script>
/* ---------- CONFIG ---------- */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwqo311vkvkbH3fM4IAboCqzgP_oebN-FxvtbQJYnk_FZKa35dDM1J4B2S5t-4Y70U_/exec';
const MAX_CORTES = 3;

/* ---------- DOM refs ---------- */
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const inlineMsg = document.getElementById('inlineMsg');
const foundCard = document.getElementById('foundCard');
const optionsBtns = document.getElementById('optionsBtns');

const categoriaSel = document.getElementById('categoria');
const tipoEncendidoSel = document.getElementById('tipoEncendido');

/* ---------- init: load validation options ---------- */
let serverValidation = { categorias: ['Carro','Camión','Moto','Maquinaria'], encendido: ['Llave','Botón'], tipoCorte: ['No recomendado','Ignición','Bomba de combustible','Señal a botón','Señal a ahogador'] };

async function loadValidation(){
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    if(data.categorias) serverValidation.categorias = data.categorias;
    if(data.encendido) serverValidation.encendido = data.encendido;
    if(data.tipoCorte) serverValidation.tipoCorte = data.tipoCorte;
  } catch(err){
    console.warn('No se pudo cargar validaciones, se usan presets.', err);
  }
  // fill selects
  fillSelect(categoriaSel, serverValidation.categorias);
  fillSelect(tipoEncendidoSel, serverValidation.encendido);
  fillAllTipoCorte();
}
loadValidation();

function fillSelect(sel, arr){
  sel.innerHTML = '';
  arr.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
}

function fillAllTipoCorte(){
  document.querySelectorAll('.tipoCorte').forEach(s => {
    s.innerHTML = '';
    serverValidation.tipoCorte.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; s.appendChild(o); });
  });
}

/* ---------- previews ---------- */
function setupPreview(inputId, imgId){
  const inp = document.getElementById(inputId);
  const img = document.getElementById(imgId);
  if(!inp||!img) return;
  inp.addEventListener('change', ()=> {
    const f = inp.files[0];
    if(!f){ img.style.display='none'; img.src=''; return; }
    img.src = URL.createObjectURL(f); img.style.display='block';
  });
}
setupPreview('imagenVehiculo','previewVehiculo');
setupPreview('aperturaImg','previewApertura');
setupPreview('cablesImg','previewCables');

/* cortes initial preview */
document.querySelectorAll('.imgCorte').forEach(input=>{
  const preview = input.parentElement.querySelector('.cortePreview');
  if(!preview) return;
  input.addEventListener('change', ()=> {
    const f = input.files[0];
    if(!f){ preview.style.display='none'; preview.src=''; return; }
    preview.src = URL.createObjectURL(f); preview.style.display='block';
  });
});

/* ---------- helpers ---------- */
function showStep(n){ step1.classList.add('hidden'); step2.classList.add('hidden'); step3.classList.add('hidden'); if(n===1) step1.classList.remove('hidden'); if(n===2) step2.classList.remove('hidden'); if(n===3) step3.classList.remove('hidden'); }
showStep(1);

function showModal(html, actions){
  const mb = document.getElementById('modalBody'); const ma = document.getElementById('modalActions');
  mb.innerHTML = html; ma.innerHTML = '';
  (actions||[]).forEach(act => {
    const b = document.createElement('button'); b.type='button'; b.textContent = act.label; b.className='small'; if(act.kind==='alt'){ b.classList.add('alt'); b.style.background='#eee'; b.style.color='#111'; }
    b.addEventListener('click', ()=> { act.onClick(); hideModal(); });
    ma.appendChild(b);
  });
  const close = document.createElement('button'); close.type='button'; close.textContent='Cerrar'; close.className='small alt'; close.addEventListener('click', hideModal);
  ma.appendChild(close);
  const mbg = document.getElementById('modalBackdrop'); mbg.style.display='flex'; mbg.classList.remove('hidden');
}
function hideModal(){ const mbg = document.getElementById('modalBackdrop'); mbg.style.display='none'; mbg.classList.add('hidden'); }

/* ---------- debounce duplicate check while typing ---------- */
let debounceTimer = null;
['marca','modelo','año'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', ()=> {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> {
      quickCheckExists();
    }, 700);
  });
});

async function quickCheckExists(){
  const marca = document.getElementById('marca').value.trim();
  const modelo = document.getElementById('modelo').value.trim();
  const año = document.getElementById('año').value.trim();
  if(!marca || !modelo || !año) { inlineMsg.textContent=''; return; }
  try {
    inlineMsg.textContent = 'Buscando registros...';
    const res = await fetch(`${WEB_APP_URL}?marca=${encodeURIComponent(marca)}&modelo=${encodeURIComponent(modelo)}&año=${encodeURIComponent(año)}`);
    const data = await res.json();
    // server may return exists/sameTypeExists/etc. We handle both possibilities.
    if(data.exists || data.cortes || data.sameTypeExists || data.rowIndex){
      inlineMsg.textContent = 'Registro encontrado. Pulsa "Buscar / Siguiente" para ver detalles.';
    } else {
      inlineMsg.textContent = 'No se encontró registro.';
    }
  } catch(err){
    inlineMsg.textContent = '';
    console.warn('checkExists error', err);
  }
}

/* ---------- STEP 1 -> Next (fetch details) ---------- */
document.getElementById('btnStep1Next').addEventListener('click', async ()=>{
  const colaborador = document.getElementById('colaborador').value.trim();
  const marca = document.getElementById('marca').value.trim();
  const modelo = document.getElementById('modelo').value.trim();
  const año = document.getElementById('año').value.trim();
  const categoria = categoriaSel.value;
  const tipoEnc = tipoEncendidoSel.value;

  if(!colaborador){ alert('Ingresa tu nombre (colaborador).'); return; }
  if(!marca || !modelo || !año){ alert('Marca, Modelo y Año son obligatorios.'); return; }

  // show searching
  inlineMsg.textContent = 'Consultando base de datos...';

  try {
    const q = `${WEB_APP_URL}?marca=${encodeURIComponent(marca)}&modelo=${encodeURIComponent(modelo)}&año=${encodeURIComponent(año)}`;
    const r = await fetch(q);
    const data = await r.json();
    inlineMsg.textContent = '';

    // Interpret response — different backend versions may return different shapes.
    // We'll try to detect:
    // - If server returns exists:true OR cortes array -> treat as existing row
    // - If not, treat as not found

    const exists = !!(data.exists || data.rowIndex || data.cortes || data.imagenVehiculo || data.sameTypeExists);

    if(!exists){
      // No registro: show message and option to create new (step2 options)
      foundCard.innerHTML = `<p>No se encontró registro para <strong>${marca} ${modelo} (${año})</strong>.</p>`;
      buildOptions(false, {});
      showStep(2);
      return;
    }

    // If exists, show details in foundCard and options conditioned by hasApertura/hasCables
    // Try to get values
    const cortes = data.cortes || data.images || [];
    const imagenVehiculo = data.imagenVehiculo || data.imagen || '';
    const hasApertura = !!data.hasApertura;
    const hasCables = !!data.hasCables;
    const colaboradores = data.colaboradores || data.colaborador || '';

    // Build HTML
    let html = `<h3>Registro encontrado</h3><p><strong>${data.marca || marca} ${data.modelo || modelo}</strong> — ${data.añoGeneracion || ''}</p>`;
    if(imagenVehiculo) html += `<div><img src="${imagenVehiculo}" class="preview" alt="Imagen modelo"></div>`;
    if(cortes && cortes.length){
      html += `<p><strong>Cortes existentes:</strong></p>`;
      cortes.forEach(c => {
        html += `<div style="margin-bottom:8px"><strong>${c.type||c.tipo||'Corte'}</strong><div>${c.desc||c.descripcion||''}</div>${c.url?`<img src="${c.url}" class="preview-sm">`:''}</div>`;
      });
    }
    if(colaboradores) html += `<p><strong>Colaboradores:</strong> ${colaboradores}</p>`;

    foundCard.innerHTML = html;
    buildOptions(true, { hasApertura, hasCables, cortes });

    showStep(2);

  } catch(err){
    inlineMsg.textContent = '';
    console.error('Error buscando registro', err);
    alert('Error consultando el servidor. Revisa la consola.');
  }
});

/* ---------- construir botones de opciones ---------- */
function buildOptions(exists, row){
  optionsBtns.innerHTML = '';
  // Always allow add corte
  const btnCorte = makeButton('Agregar nuevo corte', ()=> openFormFor('corte'));
  optionsBtns.appendChild(btnCorte);

  if(!row.hasApertura){
    const btnApertura = makeButton('Agregar apertura', ()=> openFormFor('apertura'));
    optionsBtns.appendChild(btnApertura);
  }

  if(!row.hasCables){
    const btnCables = makeButton('Agregar cables', ()=> openFormFor('cables'));
    optionsBtns.appendChild(btnCables);
  }

  const btnAll = makeButton('Agregar toda la información / Crear registro', ()=> openFormFor('all'));
  optionsBtns.appendChild(btnAll);
}

function makeButton(text, cb){
  const b = document.createElement('button'); b.type='button'; b.className='small'; b.textContent = text; b.addEventListener('click', cb); return b;
}

/* ---------- open step3 with chosen mode ---------- */
function openFormFor(mode){
  // hide all specific forms
  document.getElementById('formCortes').classList.add('hidden');
  document.getElementById('formApertura').classList.add('hidden');
  document.getElementById('formCables').classList.add('hidden');
  // show correct section(s)
  if(mode === 'corte'){ document.getElementById('formTitle').innerHTML = '<h3>Agregar Corte</h3>'; document.getElementById('formCortes').classList.remove('hidden'); }
  else if(mode === 'apertura'){ document.getElementById('formTitle').innerHTML = '<h3>Agregar Apertura</h3>'; document.getElementById('formApertura').classList.remove('hidden'); }
  else if(mode === 'cables'){ document.getElementById('formTitle').innerHTML = '<h3>Agregar Cables</h3>'; document.getElementById('formCables').classList.remove('hidden'); }
  else { document.getElementById('formTitle').innerHTML = '<h3>Agregar / Crear registro completo</h3>'; document.getElementById('formCortes').classList.remove('hidden'); document.getElementById('formApertura').classList.remove('hidden'); document.getElementById('formCables').classList.remove('hidden'); }
  // ensure tipoCorte options are set
  fillAllTipoCorte();
  showStep(3);
}

/* ---------- agregar / eliminar cortes dinámicamente ---------- */
document.getElementById('addCorteBtn').addEventListener('click', ()=> {
  const list = document.getElementById('cortesList');
  if(list.children.length >= MAX_CORTES){ alert('Máximo ' + MAX_CORTES + ' cortes.'); return; }
  const div = document.createElement('div'); div.className='corte';
  div.innerHTML = `
    <label>Tipo de corte</label><select class="tipoCorte"></select>
    <label>Descripción</label><textarea class="descCorte"></textarea>
    <label>Imagen (opcional)</label><input type="file" class="imgCorte" accept="image/*">
    <img class="preview cortePreview" style="display:none">
    <div style="margin-top:8px"><button type="button" class="removeCorteBtn small alt">Eliminar</button></div>
  `;
  list.appendChild(div);
  fillAllTipoCorte();
  // setup preview & remove
  const inp = div.querySelector('.imgCorte'); const prev = div.querySelector('.cortePreview');
  inp.addEventListener('change', ()=> { const f=inp.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });
  const btnR = div.querySelector('.removeCorteBtn'); btnR.addEventListener('click', ()=> div.remove());
});

/* ---------- Back buttons ---------- */
document.getElementById('btnBackTo1').addEventListener('click', ()=> showStep(1));
document.getElementById('btnBackTo2').addEventListener('click', ()=> showStep(2));
document.getElementById('btnReset').addEventListener('click', ()=> {
  document.getElementById('colaborador').value=''; document.getElementById('marca').value=''; document.getElementById('modelo').value=''; document.getElementById('año').value=''; document.getElementById('imagenVehiculo').value=''; document.getElementById('previewVehiculo').style.display='none'; inlineMsg.textContent='';
});

/* ---------- Submit final ---------- */
document.getElementById('btnSubmit').addEventListener('click', async ()=>{
  // basic validation
  const colaborador = document.getElementById('colaborador').value.trim();
  const marca = document.getElementById('marca').value.trim();
  const modelo = document.getElementById('modelo').value.trim();
  const año = document.getElementById('año').value.trim();
  if(!colaborador || !marca || !modelo || !año){ alert('Completa identificación (colaborador, marca, modelo, año).'); return; }

  // build cortes array
  const cortes = [];
  for(const node of document.querySelectorAll('#cortesList .corte')){
    const tipo = node.querySelector('.tipoCorte')?.value?.trim() || '';
    const desc = node.querySelector('.descCorte')?.value?.trim() || '';
    const fnode = node.querySelector('.imgCorte');
    const file = fnode?.files[0] || null;
    const base64 = file ? await fileToDataURL(file) : null;
    if(tipo || desc || base64) cortes.push({ tipo, descripcion: desc, base64, name: file?file.name:null });
  }

  // apertura
  const aperturaFile = document.getElementById('aperturaImg')?.files[0] || null;
  const apertura = { descripcion: document.getElementById('aperturaDesc')?.value?.trim() || '', base64: aperturaFile ? await fileToDataURL(aperturaFile) : null, name: aperturaFile?aperturaFile.name:null };

  // cables
  const cablesFile = document.getElementById('cablesImg')?.files[0] || null;
  const cables = { descripcion: document.getElementById('cablesDesc')?.value?.trim() || '', base64: cablesFile ? await fileToDataURL(cablesFile) : null, name: cablesFile?cablesFile.name:null };

  // imagen vehiculo
  const vehFile = document.getElementById('imagenVehiculo')?.files[0] || null;
  const imagenVehiculo = { base64: vehFile ? await fileToDataURL(vehFile) : null, name: vehFile?vehFile.name:null };

  const payload = {
    colaborador,
    categoria: categoriaSel.value,
    marca, modelo, año,
    tipoEncendido: tipoEncendidoSel.value,
    cortes,
    apertura,
    cables,
    nota: document.getElementById('nota')?.value?.trim() || '',
    plasticos: document.getElementById('plasticos')?.value?.trim() || '',
    imagenVehiculo
  };

  // show loader
  document.getElementById('loading').style.display='flex';

  try {
    const res = await fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    document.getElementById('loading').style.display='none';
    if(j && j.success){
      showModal('<h3>Éxito</h3><p>Información agregada/actualizada correctamente.</p>', [{ label:'OK', onClick: ()=> location.reload() }]);
    } else {
      console.error('Respuesta inesperada', j);
      showModal('<h3>Error</h3><p>No se pudo guardar la información. Revisa la consola.</p>', [{ label:'Cerrar', onClick: ()=> {} }]);
    }
  } catch(err){
    document.getElementById('loading').style.display='none';
    console.error(err);
    showModal('<h3>Error</h3><p>Error al comunicarse con el servidor: '+(err.message||err)+'</p>', [{ label:'Cerrar', onClick: ()=> {} }]);
  }
});

/* ---------- utilities ---------- */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result); // full dataURL
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}
function fillAllTipoCorte(){
  document.querySelectorAll('.tipoCorte').forEach(s => {
    s.innerHTML = '';
    (serverValidation.tipoCorte||[]).forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; s.appendChild(o);});
  });
}
</script>
</body>
</html>

