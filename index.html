<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Cortes de Vehículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
         /* --- ESTILOS DEL ENCABEZADO (Header) --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 20px;
        }
        .app-logo {
            max-width: 96px;
            height: auto;
            border-radius: 8px;
            margin-right: 15px;
            }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px;
        }
        .status-info { color: #2563eb; background-color: #eff6ff; border: 1px solid #bfdbfe; }
        .status-error { color: #dc2626; background-color: #fee2e2; border: 1px solid #fecaca; }
        .status-success { color: #059669; background-color: #ecfdf5; border: 1px solid #a7f3d0; }
        .status-message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
          /* --- Footer --- */
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
            background-color: #333;
            color: #fff;
            font-size: 0.9em;
            flex-shrink: 0; /* Para evitar que se comprima */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
                <div class="header-container">
            <img src="https://drive.google.com/thumbnail?id=1NxBx-W_gWmcq3fA9zog6Dpe-WXpH_2e8&sz=2048" alt="Logo de GPSpedia" class="app-logo">
            <h1 class="app-title">GPSpedia - Registro de Cortes</h1></div>
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Registro de Cortes y Aperturas</h1>

        <div id="status-message" class="status-message"></div>

        <form id="vehicle-form" class="space-y-6 card">
            <!-- Datos de Búsqueda y Identificación -->
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">1. Identificación del Vehículo</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Categoría (Col B)</label>
                    <select id="category" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div>
                    <label for="make" class="block text-sm font-medium text-gray-700">Marca (Col D)</label>
                    <input type="text" id="make" name="make" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="model" class="block text-sm font-medium text-gray-700">Modelo (Col E)</label>
                    <input type="text" id="model" name="model" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700">Año / Generación (Col G)</label>
                    <input type="text" id="year" name="year" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="ignitionType" class="block text-sm font-medium text-gray-700">Tipo de Encendido (Col F)</label>
                    <select id="ignitionType" name="ignitionType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="button" id="search-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        Buscar Coincidencia
                    </button>
                </div>
            </div>

            <!-- Sección de Cortes (Se muestra después de la búsqueda) -->
            <div id="cuts-section" style="display: none;" class="space-y-6 pt-6 border-t mt-6">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">2. Detalles de Cortes y Apertura</h2>

                <!-- Corte 1 (Principal) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutType1" class="block text-sm font-medium text-gray-700">Tipo de Corte 1 (Col H)</label>
                        <select id="cutType1" name="cutType1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div>
                        <label for="cutDescription1" class="block text-sm font-medium text-gray-700">Descripción del Corte 1 (Col I)</label>
                        <textarea id="cutDescription1" name="cutDescription1" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutImage1" class="block text-sm font-medium text-gray-700">Imagen del Corte 1 (Col J)</label>
                        <input type="file" id="cutImage1" name="cutImage1" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div id="cut-image-preview1" class="flex flex-wrap pt-2"></div>
                </div>

                <!-- Corte 2 (Secundario) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutType2" class="block text-sm font-medium text-gray-700">Tipo de Corte 2 (Col L)</label>
                        <select id="cutType2" name="cutType2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div>
                        <label for="cutDescription2" class="block text-sm font-medium text-gray-700">Descripción del Corte 2 (Col K)</label>
                        <textarea id="cutDescription2" name="cutDescription2" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutImage2" class="block text-sm font-medium text-gray-700">Imagen del Corte 2 (Col M)</label>
                        <input type="file" id="cutImage2" name="cutImage2" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div id="cut-image-preview2" class="flex flex-wrap pt-2"></div>
                </div>

                <!-- Corte 3 (Tercero) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutType3" class="block text-sm font-medium text-gray-700">Tipo de Corte 3 (Col U)</label>
                        <select id="cutType3" name="cutType3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div>
                        <label for="cutDescription3" class="block text-sm font-medium text-gray-700">Descripción del Corte 3 (Col V)</label>
                        <textarea id="cutDescription3" name="cutDescription3" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cutImage3" class="block text-sm font-medium text-gray-700">Imagen del Corte 3 (Col W)</label>
                        <input type="file" id="cutImage3" name="cutImage3" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div id="cut-image-preview3" class="flex flex-wrap pt-2"></div>
                </div>

                <!-- Apertura y Cables de Alimentación -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="openingDescription" class="block text-sm font-medium text-gray-700">Apertura / Descripción (Col N)</label>
                        <textarea id="openingDescription" name="openingDescription" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                    <div>
                        <label for="openingImage" class="block text-sm font-medium text-gray-700">Imagen de la Apertura (Col O)</label>
                        <input type="file" id="openingImage" name="openingImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <div id="opening-image-preview" class="flex flex-wrap pt-2"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="powerCables" class="block text-sm font-medium text-gray-700">Cables de Alimentación (Col Q)</label>
                        <textarea id="powerCables" name="powerCables" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>
                    <div>
                        <label for="powerImage" class="block text-sm font-medium text-gray-700">Imagen de los Cables de Alimentación (Col R)</label>
                        <input type="file" id="powerImage" name="powerImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <div id="power-image-preview" class="flex flex-wrap pt-2"></div>
                    </div>
                </div>

                <!-- Campos Adicionales -->
                <div>
                    <label for="plasticDisassembly" class="block text-sm font-medium text-gray-700">Cómo Desarmar los Plásticos (Col S)</label>
                    <textarea id="plasticDisassembly" name="plasticDisassembly" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                </div>
                <div>
                    <label for="importantNote" class="block text-sm font-medium text-gray-700">Nota Importante (Col P)</label>
                    <textarea id="importantNote" name="importantNote" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                </div>
                <div>
                    <label for="collaborator" class="block text-sm font-medium text-gray-700">Colaborador (Col T)</label>
                    <input type="text" id="collaborator" name="collaborator" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                
                <!-- Imagen del Vehículo (Col C) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="vehicleImage" class="block text-sm font-medium text-gray-700">Imagen del Vehículo (Col C)</label>
                        <input type="file" id="vehicleImage" name="vehicleImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div id="vehicle-image-preview" class="flex flex-wrap pt-2"></div>
                </div>


            </div>

            <!-- Sección de Envío -->
            <div id="submit-section" style="display: none;" class="pt-6 border-t mt-6">
                <input type="hidden" id="rowIndex" name="rowIndex">
                <input type="hidden" id="isUpdate" name="isUpdate" value="false">
                <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold">
                    Enviar Registro
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Coincidencia -->
    <div id="matchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" style="display:none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Vehículo Encontrado</h3>
            <p class="text-sm text-gray-600 mb-4">Ya existe un registro para <span id="matchVehicleInfo" class="font-semibold text-indigo-600"></span>.</p>
            <p class="text-sm text-gray-600 mb-2">Cortes existentes:</p>
            <ul id="existingCutsList" class="list-disc list-inside text-sm text-gray-700 ml-4 mb-4 bg-gray-50 p-3 rounded-md"></ul>
            <p class="text-sm text-red-600 mb-4">¿Desea continuar para **agregar** o **actualizar** la información de cortes, apertura o alimentación? Solo se llenarán las celdas vacías o el campo Colaborador.</p>
            <div class="flex justify-end space-x-4">
                <button onclick="handleMatchAction(false)" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 transition duration-150">
                    Cancelar / Reiniciar
                </button>
                <button onclick="handleMatchAction(true)" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition duration-150">
                    Continuar y Actualizar
                </button>
            </div>
        </div>
    </div>
        <footer class="footer">
        GPSpedia 2025© todos los derechos reservados.
    </footer>
    <script>
        // --- CONFIGURACIÓN GLOBAL ---
        // ATENCIÓN: Se están utilizando las credenciales proporcionadas.
        // Si el error 400/403 persiste, es casi seguro que la hoja no está COMPARTIDA PÚBLICAMENTE.
        const SPREADSHEET_ID = "1jEdC2NMc2a5F36xE2MJfgxMZiZFVfeDqnCdVizNGIMo";
        const API_KEY = "AIzaSyCooAsC52X4ccENCT6p3qh_82ErBxP47Lg";
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzmLfwa5l35omn_CdpS7AHOcLYTR9Q8-9PvjiXY0e9oTtne1BA7mDh1_4oujjmj0vGQ/exec"; // REEMPLAZAR con la URL de su App Script publicada

        // Hoja donde están los datos de vehículos
        const DATA_SHEET_NAME = "Cortes";
        // Rango de la hoja de datos que leeremos para buscar coincidencias (Marca, Modelo, Año, Cortes 1, 2, 3).
        // Columnas D (Marca, 4) a U (Tipo de corte 3, 21)
        const VEHICLE_DATA_RANGE = `${DATA_SHEET_NAME}!D:U`;
        
        // Hoja donde están las validaciones. Se asume que es la misma hoja.
        const VALIDATION_SHEET_RANGE = `${DATA_SHEET_NAME}!A:Z`;

        // Columnas a buscar para las validaciones (Índice 0-based en el rango A:Z)
        // **CORRECCIÓN CLAVE:** Los índices se ajustaron para reflejar las columnas B, F y H.
        const VALIDATION_COLUMNS = {
            category: 1,       // B: Categoria (Index 1 en A:Z)
            ignitionType: 5,   // F: Tipo de encendido (Index 5 en A:Z)
            cutType1: 7,       // H: Tipo de corte 1 (Index 7 en A:Z) - Se usa para los 3 tipos de corte.
            cutType2: 7,
            cutType3: 7,
        };
        
        // Mapeo de campos del formulario a columnas del Spreadsheet (1-based index)
        const COLUMN_MAP = {
            category: { index: 2, col: 'B' }, 
            make: { index: 4, col: 'D' }, 
            model: { index: 5, col: 'E' }, 
            ignitionType: { index: 6, col: 'F' }, 
            year: { index: 7, col: 'G' }, 
            cutType1: { index: 8, col: 'H' }, 
            cutDescription1: { index: 9, col: 'I' },
            cutDescription2: { index: 11, col: 'K' },
            cutType2: { index: 12, col: 'L' }, 
            openingDescription: { index: 14, col: 'N' }, 
            importantNote: { index: 16, col: 'P' }, 
            powerCables: { index: 17, col: 'Q' }, 
            plasticDisassembly: { index: 19, col: 'S' }, // **COLUMNA FALTANTE AGREGADA**
            collaborator: { index: 20, col: 'T' },
            cutType3: { index: 21, col: 'U' }, 
            cutDescription3: { index: 22, col: 'V' }
            // Col 1 (A): ID, Col 3(C), 10(J), 13(M), 15(O), 18(R), 23(W) son imágenes o ID (GAS Script)
        };

        // --- FUNCIONES DE UTILIDAD Y API ---

        /**
         * Muestra mensajes de estado al usuario.
         * @param {string} message Mensaje a mostrar.
         * @param {string} type Tipo de mensaje ('success', 'error', 'info').
         */
        function displayStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
            statusDiv.style.display = 'block';
            // Se mantiene el mensaje de error por más tiempo
            if (type === 'success' || type === 'error') {
                setTimeout(() => statusDiv.style.display = 'none', 10000);
            }
        }

        /**
         * Realiza una solicitud fetch con reintento y retroceso exponencial.
         * @param {string} url La URL del endpoint.
         * @param {Object} options Opciones de la solicitud fetch.
         * @param {number} retries Número actual de reintentos (interna).
         * @returns {Promise<Response>} La respuesta de la solicitud.
         */
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                
                if (!response.ok && response.status !== 404) {
                    let errorMessage = `Error HTTP ${response.status}: Fallo en la API de Google Sheets.`;

                    try {
                        const errorJson = await response.clone().json(); 
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage += ` Detalle: ${errorJson.error.message}`;
                        }
                    } catch (jsonError) {
                        // Ignorar error de parsing si no es JSON
                    }
                    
                    if (response.status === 400 || response.status === 403) {
                         errorMessage += ` -> Solución: Verifique que el SPREADSHEET_ID y API_KEY sean correctos y que la hoja esté COMPARTIDA PÚBLICAMENTE.`;
                    }

                    throw new Error(errorMessage);
                }
                return response;
            } catch (error) {
                if (retries < 5) { // 5 reintentos maximos
                    const delay = Math.pow(2, retries) * 1000;
                    // console.error(`Error en fetch. Reintentando en ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                } else {
                    console.error("Fallo de fetch después de varios reintentos.", error);
                    throw error;
                }
            }
        }

        /**
         * Carga las listas desplegables desde la hoja de validaciones.
         */
        async function loadDropdowns() {
            displayStatus('Cargando listas desplegables...');
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${VALIDATION_SHEET_RANGE}?key=${API_KEY}`;
            
            try {
                const response = await fetchWithRetry(url);
                if (!response.ok) throw new Error("Error al cargar validaciones.");

                const data = await response.json();
                const values = data.values;
                if (!values || values.length === 0) throw new Error("No se encontraron datos de validación. Asegúrese que el rango A:Z tiene datos.");

                const dropdowns = {
                    category: [],
                    ignitionType: [],
                    cutType: [] // Lista única para los 3 Tipos de Corte
                };

                // Iterar desde la segunda fila para obtener los datos de la lista (asumiendo que la fila 1 es encabezado)
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    // Usar los índices corregidos de VALIDATION_COLUMNS
                    if (row[VALIDATION_COLUMNS.category]) dropdowns.category.push(row[VALIDATION_COLUMNS.category]);
                    if (row[VALIDATION_COLUMNS.ignitionType]) dropdowns.ignitionType.push(row[VALIDATION_COLUMNS.ignitionType]);
                    if (row[VALIDATION_COLUMNS.cutType1]) dropdowns.cutType.push(row[VALIDATION_COLUMNS.cutType1]);
                }
                
                // Llenar SELECTs
                fillSelect('category', dropdowns.category);
                fillSelect('ignitionType', dropdowns.ignitionType);
                fillSelect('cutType1', dropdowns.cutType);
                fillSelect('cutType2', dropdowns.cutType);
                fillSelect('cutType3', dropdowns.cutType);

                document.getElementById('vehicle-form').style.display = 'block';
                displayStatus('Formulario listo. Ingrese los datos y presione "Buscar Coincidencia".', 'info');

            } catch (error) {
                console.error("Fallo al cargar dropdowns:", error);
                displayStatus(`Error crítico al cargar validaciones: ${error.message}`, 'error');
            }
        }

        /**
         * Rellena un elemento <select> con opciones.
         */
        function fillSelect(elementId, options) {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="">Seleccione...</option>';
            options = [...new Set(options)].filter(o => o); // Eliminar duplicados y vacíos
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }
        
        /**
         * Maneja la previsualización de archivos de imagen.
         */
        function setupImagePreviews() {
            ['vehicleImage', 'cutImage1', 'cutImage2', 'cutImage3', 'openingImage', 'powerImage'].forEach(id => {
                const input = document.getElementById(id);
                // Asegurar que el ID de preview es correcto y coincide con el HTML
                const previewContainerId = id.replace('Image', '-image-preview').toLowerCase();
                const previewContainer = document.getElementById(previewContainerId);
                
                if (input && previewContainer) {
                    input.addEventListener('change', (e) => {
                        previewContainer.innerHTML = '';
                        if (e.target.files && e.target.files.length > 0) {
                            Array.from(e.target.files).forEach(file => {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    const img = document.createElement('img');
                                    img.src = event.target.result;
                                    img.className = 'image-preview';
                                    img.alt = 'Vista previa de la imagen';
                                    previewContainer.appendChild(img);
                                };
                                reader.readAsDataURL(file);
                            });
                        }
                    });
                }
            });
        }

        /**
         * Busca la coincidencia de Marca + Modelo + Año en el Spreadsheet.
         */
        async function searchVehicle() {
            const make = document.getElementById('make').value.trim();
            const model = document.getElementById('model').value.trim();
            const year = document.getElementById('year').value.trim();

            if (!make || !model || !year) {
                displayStatus("Por favor, complete Marca, Modelo y Año para realizar la búsqueda.", 'error');
                return;
            }

            displayStatus('Buscando coincidencias...', 'info');
            
            // Usaremos un rango amplio para obtener toda la data (D:U)
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${VEHICLE_DATA_RANGE}?key=${API_KEY}`;

            try {
                const response = await fetchWithRetry(url);
                if (!response.ok) throw new Error("Error al buscar datos de vehículos.");
                
                const data = await response.json();
                const rows = data.values || [];
                
                // Los índices son relativos al rango D:U
                // Columna D (Marca): rows[i][0]
                // Columna E (Modelo): rows[i][1]
                // Columna G (Año): rows[i][3]
                // Columna H (Tipo de corte 1): rows[i][4]
                // Columna L (Tipo de corte 2): rows[i][8] (L=8 en el rango D:U)
                // Columna U (Tipo de corte 3): rows[i][17] (U=17 en el rango D:U)
                
                let foundMatch = null;
                let rowIndex = -1;

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 4) {
                        const rowMake = (row[0] || '').toLowerCase();
                        const rowModel = (row[1] || '').toLowerCase();
                        const rowYear = (row[3] || '').toLowerCase();

                        if (rowMake === make.toLowerCase() && 
                            rowModel === model.toLowerCase() && 
                            rowYear === year.toLowerCase()) {
                            
                            foundMatch = row;
                            rowIndex = i + 2; // Fila real en la hoja (1-based index, asume encabezado en fila 1)
                            break; 
                        }
                    }
                }

                document.getElementById('cuts-section').style.display = 'block';
                document.getElementById('submit-section').style.display = 'block';

                if (foundMatch) {
                    // Coincidencia encontrada: Mostrar modal de confirmación
                    const cut1 = foundMatch[4] || 'N/A'; // Columna H (index 4 en el rango D:U)
                    const cut2 = foundMatch[8] || 'N/A'; // Columna L (index 8 en el rango D:U)
                    const cut3 = foundMatch[17] || 'N/A'; // Columna U (index 17 en el rango D:U)

                    document.getElementById('matchVehicleInfo').textContent = `${make} ${model} ${year}`;
                    
                    const cutsList = document.getElementById('existingCutsList');
                    cutsList.innerHTML = '';
                    if (cut1 !== 'N/A' && cut1.trim() !== '') cutsList.innerHTML += `<li>Corte 1: ${cut1}</li>`;
                    if (cut2 !== 'N/A' && cut2.trim() !== '') cutsList.innerHTML += `<li>Corte 2: ${cut2}</li>`;
                    if (cut3 !== 'N/A' && cut3.trim() !== '') cutsList.innerHTML += `<li>Corte 3: ${cut3}</li>`;
                    if (cutsList.innerHTML === '') cutsList.innerHTML = '<li>No se han registrado cortes aún.</li>';

                    document.getElementById('rowIndex').value = rowIndex; // Fila a actualizar
                    document.getElementById('isUpdate').value = 'true';
                    
                    document.getElementById('matchModal').style.display = 'block';
                    displayStatus(`Coincidencia encontrada en la fila ${rowIndex}. Confirme la acción.`, 'info');
                } else {
                    // No hay coincidencia: Nuevo registro
                    document.getElementById('rowIndex').value = ''; 
                    document.getElementById('isUpdate').value = 'false';
                    // Limpiar descripciones para nuevo registro
                    document.getElementById('cutDescription1').value = '';
                    document.getElementById('cutDescription2').value = '';
                    document.getElementById('cutDescription3').value = '';

                    displayStatus("No se encontró coincidencia exacta. Se creará un NUEVO registro al enviar el formulario.", 'info');
                    document.getElementById('cuts-section').style.display = 'block';
                    document.getElementById('submit-section').style.display = 'block';
                }

            } catch (error) {
                console.error("Error en la búsqueda de vehículos:", error);
                displayStatus(`Error al buscar vehículos: ${error.message}`, 'error');
            }
        }
        
        /**
         * Maneja la acción después de encontrar una coincidencia.
         * @param {boolean} isProceed Si es true, continúa para agregar al registro existente. Si es false, cancela.
         */
        function handleMatchAction(isProceed) {
            document.getElementById('matchModal').style.display = 'none';

            if (isProceed) {
                displayStatus(`Continuando para agregar información a la fila ${document.getElementById('rowIndex').value}. Solo se actualizarán las celdas vacías (Cortes, Apertura, Alimentación) y el colaborador.`, 'info');
            } else {
                displayStatus('Acción cancelada. El corte/vehículo probablemente ya existe. El formulario se ha reiniciado.', 'info');
                document.getElementById('vehicle-form').reset();
                document.getElementById('cuts-section').style.display = 'none';
                document.getElementById('submit-section').style.display = 'none';
            }
        }

        /**
         * Convierte un objeto File a Base64.
         * @param {File} file 
         * @returns {Promise<string>} Base64 data URL.
         */
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- FUNCIÓN PRINCIPAL DE ENVÍO ---
        document.getElementById('vehicle-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            displayStatus('Procesando datos y subiendo archivos... Por favor, espere.', 'info');
            
            const isUpdate = document.getElementById('isUpdate').value === 'true';
            const rowIndex = document.getElementById('rowIndex').value;
            const form = e.target;
            const formData = new FormData(form);
            
            let isAnyCutDataPresent = false;
            
            // 1. Recolectar datos y mapear a columnas
            const dataArray = [];
            const filesToUpload = [];
            
            // Mapear todos los campos del formulario a un array que representa la fila de la hoja (23 columnas, A-W, usando índices 1 a 22)
            // La columna 1 (A) es el ID, no se mapea aquí.
            for (let i = 1; i <= 23; i++) {
                dataArray[i] = ""; // Inicializar
            }
            
            // Llenar el array de datos con valores del formulario
            for (const [key, map] of Object.entries(COLUMN_MAP)) {
                let value = formData.get(key) || '';
                
                // Lógica de actualización: solo se envían datos no vacíos para cortes/apertura/alimentacion/colaborador.
                if (isUpdate) {
                    if (['cutType1', 'cutDescription1', 'cutType2', 'cutDescription2', 'cutType3', 'cutDescription3', 'openingDescription', 'powerCables', 'importantNote', 'plasticDisassembly'].includes(key) && value.trim() !== '') {
                        dataArray[map.index] = value.trim();
                        isAnyCutDataPresent = true;
                    } else if (key === 'collaborator') {
                        dataArray[map.index] = value.trim(); 
                    }
                } else {
                    // Modo de nueva fila: llenar todos los campos
                    dataArray[map.index] = value.trim();
                }
            }
            
            // Si es una actualización, y no se ingresó nada nuevo, no se procede con la hoja de cálculo.
            if (isUpdate && !isAnyCutDataPresent && form.elements['vehicleImage'].files.length === 0 && form.elements['cutImage1'].files.length === 0 && form.elements['cutImage2'].files.length === 0 && form.elements['cutImage3'].files.length === 0 && form.elements['openingImage'].files.length === 0 && form.elements['powerImage'].files.length === 0) {
                 displayStatus('Advertencia: No se detectaron cambios en texto ni imágenes. Envío cancelado.', 'error');
                 return;
            }


            // 2. Recolectar archivos y convertirlos a Base64
            const fileInputs = [
                { inputId: 'vehicleImage', type: 'imagenVehiculo' },
                { inputId: 'cutImage1', type: 'imagenCorte1' },
                { inputId: 'cutImage2', type: 'imagenCorte2' },
                { inputId: 'cutImage3', type: 'imagenCorte3' },
                { inputId: 'openingImage', type: 'imagenApertura' },
                { inputId: 'powerImage', type: 'imagenAlimentacion' }
            ];

            for (const { inputId, type } of fileInputs) {
                const input = form.elements[inputId];
                if (input && input.files && input.files.length > 0) {
                    const file = input.files[0];
                    const base64 = await toBase64(file);
                    filesToUpload.push({
                        fileName: file.name,
                        mimeType: file.type,
                        base64Data: base64.split(',')[1],
                        type: type
                    });
                }
            }

            // 3. ENVIAR DATOS DE LA HOJA DE CÁLCULO (NO IMAGEN)
            let finalRowIndex;

            // Rango de datos a enviar: De la columna B (index 2) a la columna V (index 22). 
            // W (index 23) es la última imagen, manejada por GAS.
            // ID (index 1) es la primera columna.
            const dataSlice = dataArray.slice(2, 23); // Columna B (index 2) a V (index 22)

            if (isUpdate) {
                // Modo ACTUALIZACIÓN (PUT request)
                finalRowIndex = rowIndex;
                const range = `${DATA_SHEET_NAME}!B${finalRowIndex}:V${finalRowIndex}`;

                if (isAnyCutDataPresent) {
                    try {
                        const updateUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED&key=${API_KEY}`;
                        const updateResponse = await fetchWithRetry(updateUrl, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ values: [dataSlice] })
                        });

                        if (!updateResponse.ok) throw new Error("Fallo al actualizar el registro en Google Sheets.");

                    } catch (error) {
                        displayStatus(`Error al actualizar datos: ${error.message}`, 'error');
                        return;
                    }
                } else {
                    displayStatus('Registro de hoja de cálculo NO actualizado (sin cambios en texto/selects). Procediendo solo con imágenes si existen.', 'info');
                }

            } else {
                // Modo NUEVO REGISTRO (POST/Append request)
                try {
                    // Rango de append: B:V para evitar tocar la columna A (ID) y W (última imagen).
                    const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${DATA_SHEET_NAME}!B:V:append?valueInputOption=USER_ENTERED&key=${API_KEY}`;
                    const appendResponse = await fetchWithRetry(appendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [dataSlice] })
                    });
                    
                    if (!appendResponse.ok) throw new Error("Fallo al crear el nuevo registro en Google Sheets.");
                    
                    const result = await appendResponse.json();
                    // Obtener la fila de la celda de la última celda escrita
                    const updatedRange = result.updates.updatedRange;
                    finalRowIndex = parseInt(updatedRange.match(/([0-9]+)$/)[0]);
                } catch (error) {
                    displayStatus(`Error al crear nuevo registro: ${error.message}`, 'error');
                    return;
                }
            }

            // 4. ENVIAR IMÁGENES A GOOGLE APPS SCRIPT
            if (filesToUpload.length > 0) {
                displayStatus(`Registro de datos completado en la fila ${finalRowIndex}. Subiendo ${filesToUpload.length} imágenes a Google Drive...`, 'info');
                
                const gasPayload = {
                    row: finalRowIndex,
                    category: dataArray[COLUMN_MAP.category.index],
                    make: dataArray[COLUMN_MAP.make.index],
                    model: dataArray[COLUMN_MAP.model.index],
                    year: dataArray[COLUMN_MAP.year.index],
                    collaborator: dataArray[COLUMN_MAP.collaborator.index],
                    isUpdate: isUpdate,
                    files: filesToUpload
                };
                
                try {
                    const gasResponse = await fetchWithRetry(GAS_WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(gasPayload),
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const gasResult = await gasResponse.json();
                    if (gasResult.status === 200) {
                        displayStatus(`¡Éxito! Registro completo en la fila ${finalRowIndex}. Imágenes subidas y enlaces actualizados.`, 'success');
                        form.reset();
                        document.getElementById('cuts-section').style.display = 'none';
                        document.getElementById('submit-section').style.display = 'none';
                        setupImagePreviews(); // Limpiar previsualizaciones
                    } else {
                        throw new Error(gasResult.message || "Fallo en la respuesta de Google Apps Script.");
                    }
                } catch (error) {
                    displayStatus(`Error al subir imágenes a Drive: ${error.message}. El registro de datos de texto ya fue guardado en la fila ${finalRowIndex}.`, 'error');
                }
            } else {
                displayStatus(`¡Éxito! Registro de datos de texto completado en la fila ${finalRowIndex}. No se adjuntaron imágenes.`, 'success');
                form.reset();
                document.getElementById('cuts-section').style.display = 'none';
                document.getElementById('submit-section').style.display = 'none';
                setupImagePreviews(); // Limpiar previsualizaciones
            }
        });

        // --- INICIALIZACIÓN ---
        window.onload = () => {
            loadDropdowns();
            setupImagePreviews();
            document.getElementById('search-btn').addEventListener('click', searchVehicle);
        };
    </script>
</body>
</html>
