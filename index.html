<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agregar Corte</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: 'Inter', Arial, sans-serif;
        padding: 15px;
        background: #f5f5f5;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .container {
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .step {
        display: none;
        padding: 10px 0;
    }

    .step.active {
        display: block;
    }

    .btn {
        background: #111;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        margin-top: 10px;
        transition: background-color 0.3s;
    }

    .btn:hover {
        background: #333;
    }

    .btn-secondary {
        background: #555;
    }

    .btn-secondary:hover {
        background: #777;
    }

    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .btn-group .btn {
        flex: 1;
        margin-top: 0;
    }

    .loading {
        display: none;
        font-size: 18px;
        margin-top: 20px;
        text-align: center;
        color: #333;
    }
    
    label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    input[type="text"], input[type="number"], select, textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .image-preview {
        width: 100%;
        max-height: 200px;
        object-fit: contain;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 10px;
        display: block;
    }

    .message-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .message-content {
        background: white;
        padding: 25px;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .header-title {
        text-align: center;
        color: #111;
        margin-bottom: 20px;
    }
</style>
</head>
<body>

<div class="container">
    <h1 class="header-title">Registro de Cortes de Vehículo.1</h1>

    <!-- Paso 1: Información Base (Colaborador, Vehículo, Imagen Vehículo) -->
    <div id="step1" class="step active">
        <label for="colaborador">Colaborador (Columna T)</label>
        <input type="text" id="colaborador" placeholder="Tu Nombre">

        <label for="categoria">Categoría (Columna D)</label>
        <select id="categoria">
            <!-- Opciones cargadas por JS -->
        </select>

        <label for="marca">Marca (Columna D)</label>
        <input type="text" id="marca" placeholder="Ej: Toyota">

        <label for="modelo">Modelo (Columna D)</label>
        <input type="text" id="modelo" placeholder="Ej: Hilux">

        <label for="año">Año (Columna G)</label>
        <input type="number" id="año" placeholder="Ej: 2023">
        
        <label>Imagen del Vehículo (Columna C)</label>
        <input type="file" id="imgVehiculo" accept="image/*">
        <img id="previewVehiculo" class="image-preview" style="display: none;">

        <div class="btn-group">
            <button class="btn" onclick="buscarModelo()">Buscar y Siguiente</button>
        </div>
        <p class="loading" id="loadingBusqueda">Buscando modelo...</p>
    </div>

    <!-- Paso 2: Detalles del Primer Corte (Encendido, Corte 1) -->
    <div id="step2" class="step">
        <h2 id="accionTitle" style="text-align: center;"></h2>
        <div id="contenidoStep2">
            <!-- Contenido dinámico para actualizaciones o fijo para nuevo modelo -->
            <h3 style="margin-top: 0;">Información del Corte 1</h3>
            
            <label for="tipoEncendido">Tipo de Encendido (Columna F)</label>
            <select id="tipoEncendido">
                <!-- Opciones cargadas por JS -->
            </select>
            
            <label for="tipoCorte1">Tipo de Corte 1 (Columna H)</label>
            <select id="tipoCorte1">
                <!-- Opciones cargadas por JS y es el desplegable que faltaba! -->
            </select>

            <label>Descripción Corte 1 (Columna I)</label>
            <textarea id="descCorte1"></textarea>

            <label>Imagen Corte 1 (Columna J)</label>
            <input type="file" id="imgCorte1" accept="image/*">
            <img id="previewCorte1" class="image-preview" style="display: none;">
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="mostrarPaso(1)">Atrás</button>
            <button class="btn" onclick="mostrarPaso(3)">Siguiente (Opcionales)</button>
        </div>
    </div>

    <!-- Paso 3: Opcionales (Plásticos, Corte 2/3, Apertura, Cables, Notas) -->
    <div id="step3" class="step">
        <h2 style="text-align: center;">Detalle de la Información Opcional</h2>
        <div id="contenidoStep3">
            <!-- Contenido dinámico (Como Desarmar Plásticos, Corte 2/3, Apertura, Cables, etc.) -->
            <label>Cómo Desarmar Plásticos (Columna S)</label>
            <textarea id="comoDesarmarPlasticos"></textarea>
            
            <p style="margin-top: 25px; font-weight: bold; border-top: 1px solid #ddd; padding-top: 15px;">Otras Secciones Opcionales</p>
            <!-- El resto de formularios dinámicos se carga aquí si es un modelo existente -->
            
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="mostrarPaso(2)">Atrás</button>
            <button class="btn" id="btnEnviar" onclick="enviar()">Guardar y Terminar</button>
        </div>
        <p class="loading" id="loading">Guardando datos...</p>
    </div>
</div>

<!-- Custom Message Box (Reemplazo de alert()) -->
<div id="messageBox" class="message-box">
    <div class="message-content">
        <p id="messageText"></p>
        <button class="btn" onclick="hideMessage()">Aceptar</button>
    </div>
</div>

<script>
    // ** CRÍTICO: URL de Despliegue **
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk45LuYuhAEnm2Wr8gbe3CdcT9rTYP0BLbEnDx-Hx716lSj8HLesbPJuWLpC_C5n7f/exec';

    let categoriasData = [];
    let tipoEncendidoData = [];
    let tipoCorteData = [];
    let accionSeleccionada = 'nuevoModelo'; // 'nuevoModelo' | 'corteNuevo' | 'apertura' | 'cables' | 'imagenVehiculoUpdate' | 'plasticos' | 'nota'
    let modeloExistenteRowIndex = null;
    let resultBusqueda = {}; // Guarda el resultado de la búsqueda
    
    // Variables de estado para imágenes en base64
    let imagenVehiculoBase64 = null;
    let imagenCorteBase64 = null;
    let imagenAperturaBase64 = null;
    let imagenCablesBase64 = null;


    // --- Utilidades de UI ---

    function showMessage(text) {
        document.getElementById("messageText").innerText = text;
        document.getElementById("messageBox").style.display = 'flex';
    }

    function hideMessage() {
        document.getElementById("messageBox").style.display = 'none';
        // Recargar la página solo si el mensaje es de éxito
        if (document.getElementById("messageText").innerText.includes("Guardado correctamente") ||
            document.getElementById("messageText").innerText.includes("Error: Ya existen 3 cortes")
        ) {
             // Evita la recarga automática después de un error de 3 cortes, solo recarga tras éxito
             if (document.getElementById("messageText").innerText.includes("Guardado correctamente")) {
                location.reload();
             }
        }
    }
    
    function showLoading(elementId, show) {
        document.getElementById(elementId).style.display = show ? 'block' : 'none';
    }

    // --- Carga Inicial de Listas de Validación ---
    async function loadValidationData() {
        showLoading('loadingBusqueda', true);
        try {
            const url = `${WEB_APP_URL}?action=getValidationData`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`Error en la carga inicial: ${res.status} ${res.statusText}`);
            }
            
            const data = await res.json();
            
            categoriasData = data.categorias || [];
            tipoEncendidoData = data.tipoEncendido || [];
            tipoCorteData = data.tipoCorte || [];

            populateSelect('categoria', categoriasData);
            populateSelect('tipoEncendido', tipoEncendidoData);
            populateSelect('tipoCorte1', tipoCorteData); // <--- CORRECCIÓN CLAVE: Llenar el desplegable

        } catch (error) {
            console.error("Error al cargar datos de validación:", error);
            showMessage(`Error de conexión inicial. Por favor, revisa la URL y el despliegue de Apps Script. Detalle: ${error.message}`);
        } finally {
            showLoading('loadingBusqueda', false);
        }
    }

    function populateSelect(id, data) {
        const select = document.getElementById(id);
        if (select) {
            select.innerHTML = '<option value="">-- Seleccione --</option>';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }
    }

    // --- Lógica de Búsqueda de Modelo ---
    async function buscarModelo() {
        const marca = document.getElementById("marca").value.trim();
        const modelo = document.getElementById("modelo").value.trim();
        const anio = document.getElementById("año").value;
        const colaborador = document.getElementById("colaborador").value.trim();
        
        if (!colaborador || !marca || !modelo || !anio) {
            showMessage("Por favor, complete Colaborador, Marca, Modelo y Año para buscar.");
            return;
        }
        
        if (document.getElementById("imgVehiculo").files.length === 0) {
            showMessage("Por favor, adjunte la Imagen del Vehículo (Paso 1).");
            return;
        }


        showLoading('loadingBusqueda', true);

        try {
            const url = `${WEB_APP_URL}?action=buscarModelo&marca=${encodeURIComponent(marca)}&modelo=${encodeURIComponent(modelo)}&anio=${anio}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`Error de red al buscar modelo: ${res.status} ${res.statusText}`);
            }
            
            const result = await res.json();
            resultBusqueda = result; // Guardar el resultado para usar en configurarModoActualizacion

            if (result.existe) {
                // Modelo encontrado, se procede a la actualización
                modeloExistenteRowIndex = result.rowIndex;
                configurarModoActualizacion(result);
            } else {
                // Modelo no encontrado, se procede a nuevo registro
                accionSeleccionada = 'nuevoModelo';
                document.getElementById('accionTitle').innerText = 'Nuevo Registro - Detalle Corte 1';
                configurarContenidoPaso3('corte1'); // Muestra los campos de plásticos/opcionales
                mostrarPaso(2);
            }
            
        } catch (error) {
            console.error("Error en buscarModelo:", error);
            showMessage(`Error al buscar modelo: ${error.message}. Verifica la conexión.`);
        } finally {
            showLoading('loadingBusqueda', false);
        }
    }
    
    // --- Configuración de Modos ---
    
    function configurarModoActualizacion(result) {
        const tieneCorte1 = result.tieneCorte1;
        const tieneCorte2 = result.tieneCorte2;
        const tieneCorte3 = result.tieneCorte3;
        const tieneApertura = result.tieneApertura;
        const tieneCables = result.tieneCables;

        let opcion = '';
        let title = 'Actualizar Modelo Existente';
        
        // Determinar qué acción falta o se debe actualizar
        if (!tieneCorte1 || !tieneCorte2 || !tieneCorte3) {
            opcion = 'corteNuevo';
            title = 'Agregar Corte Adicional';
            configurarContenidoPaso3(opcion);
        } else if (!tieneApertura) {
            opcion = 'apertura';
            title = 'Agregar Apertura';
            configurarContenidoPaso3(opcion);
        } else if (!tieneCables) {
            opcion = 'cables';
            title = 'Agregar Cables de Alimentación';
            configurarContenidoPaso3(opcion);
        } else {
             // Si todo está completo, se ofrecen otras actualizaciones
             opcion = 'nota'; 
             title = 'Actualización General';
             configurarContenidoPaso3('fullUpdate');
             // Forzar a Step 3 directamente, saltando Step 2
             mostrarPaso(3);
             return;
        }

        accionSeleccionada = opcion;
        document.getElementById('accionTitle').innerText = title;
        
        // Para actualizaciones específicas, el Paso 2 es solo informativo
        document.getElementById("contenidoStep2").innerHTML = `
            <p style="color: #007bff; font-weight: bold; text-align: center;">Modelo encontrado. La siguiente sección le permitirá agregar la información faltante.</p>
        `;
        
        // Saltamos a paso 3, ya que el paso 2 ya no contiene los campos iniciales de vehículo.
        mostrarPaso(3);
    }
    
    function configurarContenidoPaso3(tipo) {
        const contenido = document.getElementById("contenidoStep3");
        let html = '';
        let btnText = 'Guardar y Terminar';
        
        // Si es 'nuevoModelo', el contenido de Step 3 incluye 'Desarmar Plásticos'
        if (tipo === 'corte1') {
            html += `
                <label>Cómo Desarmar Plásticos (Columna S)</label>
                <textarea id="comoDesarmarPlasticos"></textarea>
                <hr style="margin: 20px 0;">
                <p style="font-weight: bold;">Otros campos de actualización estarán disponibles después del primer registro.</p>
            `;
            accionSeleccionada = 'nuevoModelo';
        }


        switch(tipo) {
            case 'corteNuevo':
                const nextCorteNum = resultBusqueda.tieneCorte1 && resultBusqueda.tieneCorte2 && !resultBusqueda.tieneCorte3 ? 3 : 
                                     (resultBusqueda.tieneCorte1 && !resultBusqueda.tieneCorte2 ? 2 : 1);
                
                // Si el modelo ya tiene 3 cortes, se avisa
                if (nextCorteNum > 3 || (resultBusqueda.tieneCorte1 && resultBusqueda.tieneCorte2 && resultBusqueda.tieneCorte3)) {
                     showMessage("Error: Ya existen 3 cortes (Corte 1, 2 y 3) para este vehículo. No se puede añadir un corte adicional.");
                     // Vuelve al paso 1 y evita que se muestre el form
                     mostrarPaso(1);
                     return;
                }
                
                accionSeleccionada = 'corteNuevo';
                html = `
                    <h3>Corte Adicional (Corte ${nextCorteNum})</h3>
                    <label for="tipoCorte">Tipo de Corte</label>
                    <select id="tipoCorte"></select>

                    <label>Descripción Corte ${nextCorteNum}</label>
                    <textarea id="descCorte"></textarea>

                    <label>Imagen Corte ${nextCorteNum}</label>
                    <input type="file" id="imgCorte" accept="image/*">
                    <img id="previewCorte" class="image-preview" style="display: none;">
                `;
                // Se agrega el formulario al final del contenido actual
                contenido.innerHTML = contenido.innerHTML + html; 
                populateSelect('tipoCorte', tipoCorteData);
                break;

            case 'apertura':
                accionSeleccionada = 'apertura';
                html = `
                    <h3>Apertura de Puertas</h3>
                    <label>Descripción Apertura</label>
                    <textarea id="descApertura"></textarea>

                    <label>Imagen Apertura</label>
                    <input type="file" id="imgApertura" accept="image/*">
                    <img id="previewApertura" class="image-preview" style="display: none;">
                `;
                contenido.innerHTML = html;
                break;

            case 'cables':
                accionSeleccionada = 'cables';
                html = `
                    <h3>Cables de Alimentación</h3>
                    <label>Descripción Cables</label>
                    <textarea id="descCables"></textarea>

                    <label>Imagen Cables</label>
                    <input type="file" id="imgCables" accept="image/*">
                    <img id="previewCables" class="image-preview" style="display: none;">
                `;
                contenido.innerHTML = html;
                break;
                
            case 'fullUpdate':
                html = `
                    <p style="font-weight: bold;">El modelo parece estar completo. Seleccione lo que desea actualizar:</p>

                    <button class="btn btn-secondary" style="margin-bottom: 10px;" onclick="configurarActualizacionForm('plasticos', 'Desarmado de Plásticos (S)')">Actualizar Desarmado Plásticos</button>
                    <button class="btn btn-secondary" style="margin-bottom: 10px;" onclick="configurarActualizacionForm('imagenVehiculoUpdate', 'Imagen Vehículo (C)')">Actualizar Imagen Vehículo</button>
                    <button class="btn btn-secondary" style="margin-bottom: 10px;" onclick="configurarActualizacionForm('nota', 'Nota Importante (V)')">Actualizar Nota Importante</button>

                    <div id="updateForm" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; display: none;">
                        <h4 id="updateFormTitle"></h4>
                        <div id="updateFormContent"></div>
                        <button class="btn" style="margin-top: 15px;" onclick="enviar()">Guardar Actualización</button>
                    </div>
                `;
                btnText = 'Finalizar';
                contenido.innerHTML = html;
                break;
        }
        
        document.getElementById('btnEnviar').textContent = btnText;
        
        // Adjuntar listeners de archivos solo si hay inputs de tipo file en el DOM
        if (document.getElementById('imgCorte1')) {
            document.getElementById('imgCorte1').addEventListener('change', (e) => handleImageUpload(e, 'corte1'));
        }
        if (document.getElementById('imgCorte')) {
            document.getElementById('imgCorte').addEventListener('change', (e) => handleImageUpload(e, 'corte'));
        }
        if (document.getElementById('imgApertura')) {
            document.getElementById('imgApertura').addEventListener('change', (e) => handleImageUpload(e, 'apertura'));
        }
        if (document.getElementById('imgCables')) {
            document.getElementById('imgCables').addEventListener('change', (e) => handleImageUpload(e, 'cables'));
        }
        // Listener para imagen de vehículo (si existe en Step 1)
        if (document.getElementById('imgVehiculo')) {
            document.getElementById('imgVehiculo').addEventListener('change', (e) => handleImageUpload(e, 'vehiculo'));
        }
    }
    
    function configurarActualizacionForm(accion, title) {
        accionSeleccionada = accion;
        const formDiv = document.getElementById('updateFormContent');
        document.getElementById('updateFormTitle').innerText = title;

        let html = '';

        switch(accion) {
            case 'imagenVehiculoUpdate':
                html = `
                    <label>Nueva Imagen del Vehículo</label>
                    <input type="file" id="imgUpdateVehiculo" accept="image/*">
                    <img id="previewUpdateVehiculo" class="image-preview" style="display: none;">
                `;
                break;
            case 'plasticos':
                html = `<label>Cómo Desarmar Plásticos</label><textarea id="comoDesarmarPlasticosUpdate"></textarea>`;
                break;
            case 'nota':
                html = `<label>Nota Importante</label><textarea id="notaImportanteUpdate"></textarea>`;
                break;
        }
        
        formDiv.innerHTML = html;
        document.getElementById('updateForm').style.display = 'block';

        // Re-adjuntar listeners para el formulario de actualización
        if (document.getElementById('imgUpdateVehiculo')) {
            document.getElementById('imgUpdateVehiculo').addEventListener('change', (e) => handleImageUpload(e, 'updateVehiculo'));
        }
    }


    // --- Manejo de Archivos ---

    function handleImageUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1];
            const previewId = {
                'vehiculo': 'previewVehiculo',
                'updateVehiculo': 'previewUpdateVehiculo',
                'corte1': 'previewCorte1',
                'corte': 'previewCorte',
                'apertura': 'previewApertura',
                'cables': 'previewCables'
            }[type];
            
            const base64Var = {
                'vehiculo': 'imagenVehiculoBase64',
                'updateVehiculo': 'imagenVehiculoBase64',
                'corte1': 'imagenCorteBase64',
                'corte': 'imagenCorteBase64',
                'apertura': 'imagenAperturaBase64',
                'cables': 'imagenCablesBase64'
            }[type];
            
            window[base64Var] = base64Data;
            
            if (previewId) {
                const preview = document.getElementById(previewId);
                if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
            }
        };

        reader.onerror = function() {
            showMessage("Error al leer la imagen.");
        };

        reader.readAsDataURL(file);
    }

    // --- ENVIAR FORMULARIO ---
    async function enviar(){
        const colaborador = document.getElementById("colaborador").value;
        const marca = document.getElementById("marca").value;
        const modelo = document.getElementById("modelo").value;
        const anio = Number(document.getElementById("año").value);

        if (!colaborador || !marca || !modelo || !anio) {
            showMessage("El colaborador, la marca, el modelo y el año son obligatorios.");
            return;
        }

        let payload = {
            colaborador,
            marca,
            modelo,
            anio,
            accion: accionSeleccionada,
            rowIndex: modeloExistenteRowIndex
        };
        
        // Construir el payload basado en la acción
        switch(accionSeleccionada) {
            case 'nuevoModelo':
                payload.categoria = document.getElementById("categoria").value;
                payload.tipoEncendido = document.getElementById("tipoEncendido").value;
                payload.comoDesarmarPlasticos = document.getElementById("comoDesarmarPlasticos").value;
                
                if (!payload.categoria || !payload.tipoEncendido) {
                    showMessage("Faltan campos obligatorios para el Nuevo Modelo (Categoría/Encendido).");
                    return;
                }
                
                // Imágenes obligatorias para Nuevo Modelo
                if (document.getElementById("imgVehiculo").files.length === 0 || document.getElementById("imgCorte1").files.length === 0) {
                    showMessage("Debe adjuntar la imagen del vehículo (Paso 1) y la imagen del Corte 1 (Paso 2).");
                    return;
                }
                
                payload.imagenVehiculo = { 
                    base64: imagenVehiculoBase64, 
                    name: document.getElementById("imgVehiculo").files[0].name 
                };
                
                payload.corte1 = {
                    tipoCorte: document.getElementById("tipoCorte1").value,
                    descripcion: document.getElementById("descCorte1").value,
                    imagen: { 
                        base64: imagenCorteBase64, 
                        name: document.getElementById("imgCorte1").files[0].name 
                    }
                };
                if (!payload.corte1.tipoCorte) {
                    showMessage("El Tipo de Corte 1 es obligatorio.");
                    return;
                }
                break;

            case 'corteNuevo':
                if (document.getElementById("imgCorte").files.length === 0) {
                    showMessage("Debe adjuntar la imagen para el nuevo corte.");
                    return;
                }
                payload.corte = {
                    tipoCorte: document.getElementById("tipoCorte").value,
                    descripcion: document.getElementById("descCorte").value,
                    imagen: { 
                        base64: imagenCorteBase64, 
                        name: document.getElementById("imgCorte").files[0].name 
                    }
                };
                if (!payload.corte.tipoCorte) {
                    showMessage("El Tipo de Corte es obligatorio.");
                    return;
                }
                break;

            case 'apertura':
                if (document.getElementById("imgApertura").files.length === 0) {
                    showMessage("Debe adjuntar la imagen para la apertura.");
                    return;
                }
                payload.apertura = {
                    descripcion: document.getElementById("descApertura").value,
                    imagen: { 
                        base64: imagenAperturaBase64, 
                        name: document.getElementById("imgApertura").files[0].name 
                    }
                };
                break;

            case 'cables':
                if (document.getElementById("imgCables").files.length === 0) {
                    showMessage("Debe adjuntar la imagen para los cables de alimentación.");
                    return;
                }
                payload.cables = {
                    descripcion: document.getElementById("descCables").value,
                    imagen: { 
                        base64: imagenCablesBase64, 
                        name: document.getElementById("imgCables").files[0].name 
                    }
                };
                break;

            case 'imagenVehiculoUpdate':
                if (document.getElementById("imgUpdateVehiculo").files.length === 0) {
                    showMessage("Debe adjuntar la nueva imagen del vehículo.");
                    return;
                }
                payload.imagenVehiculo = { 
                    base64: imagenVehiculoBase64, 
                    name: document.getElementById("imgUpdateVehiculo").files[0].name 
                };
                break;

            case 'plasticos':
                payload.comoDesarmarPlasticos = document.getElementById("comoDesarmarPlasticosUpdate").value;
                if (!payload.comoDesarmarPlasticos) {
                    showMessage("La descripción de los plásticos no puede estar vacía.");
                    return;
                }
                break;

            case 'nota':
                payload.notaImportante = document.getElementById("notaImportanteUpdate").value;
                 if (!payload.notaImportante) {
                    showMessage("La Nota Importante no puede estar vacía.");
                    return;
                }
                break;
                
            default:
                showMessage("Acción de guardado no válida.");
                return;
        }


        showLoading('loading', true);

        try {
            const res = await fetch(WEB_APP_URL, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            showLoading('loading', false);
            
            if (!res.ok) {
                 // Leer el cuerpo de la respuesta para obtener el error del servidor si es posible
                const errorText = await res.text();
                throw new Error(`Error de red o servidor: ${res.status} ${res.statusText}. Mensaje del servidor: ${errorText.substring(0, 100)}...`);
            }
            
            const result = await res.json();
            
            if (result.success) {
                showMessage("Guardado correctamente.");
            } else {
                showMessage(`Error en función enviar: ${result.error || 'Error desconocido'}`);
            }

        } catch (error) {
            showLoading('loading', false);
            console.error("Error en la función enviar:", error);
            showMessage(`Error en función enviar: ${error.message}`);
        }
    }


    // --- Cambiar pasos ---
    function mostrarPaso(n){
        document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
        document.getElementById(`step${n}`).classList.add("active");
        
        // Si vamos al paso 2, reconfiguramos el contenido por si venimos de buscarModelo
        if (n === 2 && accionSeleccionada === 'nuevoModelo') {
            // Asegura que los desplegables se llenen si volvemos del paso 3 o inicio
            populateSelect('tipoEncendido', tipoEncendidoData);
            populateSelect('tipoCorte1', tipoCorteData);
            
            document.getElementById("contenidoStep2").innerHTML = `
                <h3 style="margin-top: 0;">Información del Corte 1</h3>
                
                <label for="tipoEncendido">Tipo de Encendido (Columna F)</label>
                <select id="tipoEncendido"></select>
                
                <label for="tipoCorte1">Tipo de Corte 1 (Columna H)</label>
                <select id="tipoCorte1"></select>

                <label>Descripción Corte 1 (Columna I)</label>
                <textarea id="descCorte1"></textarea>

                <label>Imagen Corte 1 (Columna J)</label>
                <input type="file" id="imgCorte1" accept="image/*">
                <img id="previewCorte1" class="image-preview" style="display: none;">
            `;
            // Re-adjuntar listeners y llenar desplegables
            populateSelect('tipoEncendido', tipoEncendidoData);
            populateSelect('tipoCorte1', tipoCorteData);
            if (document.getElementById('imgCorte1')) {
                document.getElementById('imgCorte1').addEventListener('change', (e) => handleImageUpload(e, 'corte1'));
            }
        }
        
        // Si vamos al paso 3, reconfiguramos los opcionales si es nuevo modelo
        if (n === 3 && accionSeleccionada === 'nuevoModelo') {
            configurarContenidoPaso3('corte1');
        }
    }

    // --- Inicialización ---
    window.onload = loadValidationData;

</script>
</body>
</html>
