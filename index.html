<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Cortes GPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Estilos Globales basados en Tailwind */
html { height: 100%; }
body {
    font-family: 'Inter', sans-serif;
    margin: 0; padding: 20px;
    background: #f0f4f8;
    display: flex; flex-direction: column;
    min-height: 100vh;
}
.container {
    max-width: 500px;
    margin: 20px auto;
    width: 100%;
    box-sizing: border-box;
    flex: 1 0 auto;
}
.form-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.step { display: none; }
.step.active { display: block; }

label {
    display: block; margin-top: 15px; margin-bottom: 5px;
    font-weight: bold; color: #333;
}
input[type="text"], input[type="number"], select, textarea {
    width: 100%; padding: 10px; margin-bottom: 10px;
    border: 1px solid #ccc; border-radius: 6px;
    box-sizing: border-box; font-size: 1em;
    transition: border-color 0.3s;
}
.custom-file-upload {
    display: block; width: 100%; padding: 10px; margin-bottom: 15px;
    border: 1px solid #007bff; border-radius: 6px; box-sizing: border-box;
    font-size: 1em; font-weight: 500; color: #007bff;
    background-color: #f0f8ff; cursor: pointer; text-align: center;
}
.input-file-hidden {
    width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1;
}
.btn {
    background: #007bff; color: white; border: none; padding: 12px;
    border-radius: 8px; cursor: pointer; width: 100%; font-size: 1em;
    font-weight: bold; transition: background-color 0.3s; margin-top: 10px;
}
.btn:hover { background: #0056b3; }
.btn-secondary { background: #6c757d; }
.btn-secondary:hover { background: #5a6268; }
.loading {
    display: none; font-size: 1em; margin-top: 15px; text-align: center;
    color: #007bff; font-weight: bold;
}
.alerta {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    padding: 15px 25px; border-radius: 8px; font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1000; opacity: 0;
    transition: opacity 0.5s, transform 0.5s; text-align: center;
    background-color: #d4edda; color: #155724;
}
.alerta.show { opacity: 1; transform: translate(-50%, 0); }
.alerta.error { background-color: #f8d7da; color: #721c24; }
.image-preview {
    max-width: 100%; height: auto; border-radius: 8px; margin-top: 5px; 
    margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); object-fit: contain;
}
.cortes-existentes-info {
    padding: 10px; margin-bottom: 15px; background-color: #f0f8ff; 
    border: 1px solid #cce5ff; border-radius: 8px;
}
.backBtn {
    margin-bottom: 15px; cursor: pointer; color: #007bff; 
    display: inline-flex; align-items: center; font-weight: bold;
}
</style>
</head>
<body>

<div class="container">
    <div class="form-card">
        <h1 class="text-2xl font-bold mb-6 text-gray-800 text-center">Registro de Cortes GPS</h1>

        <script>
        // -------------------------------------------------------------
        // CONFIGURACI√ìN - ¬°REEMPLAZA ESTE VALOR!
        // -------------------------------------------------------------
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFxWvJG5pJMLX5Wi2Xw8fl-cjeidFIQbQ_fL7TeeHZVKmANCJgDP4U21KbhKm2LE74/exec'; 
        
        // Opciones de selecci√≥n
        const CATEGORIA_OPTIONS = ['Carro', 'Cami√≥n', 'Moto', 'Construcci√≥n/Otros'];
        const TIPO_ENCENDIDO_OPTIONS = ['llave', 'boton'];
        const TIPO_CORTE_OPTIONS = ['No recomendable', 'Ignicion', 'Bomba de combustible', 'Ahogador', 'Se√±al a bot√≥n', 'No aplica'];

        // Variables de estado
        let filaIndexExistente = null; // Fila en Sheets (base 1)
        let datosCorteExistente = {}; // Almacena los tipos de corte H, L, U
        let nextCorte = 1;             // 1, 2, 3 o 4 (lleno)
        
        // Almacenamiento de Base64 de las im√°genes
        const imagesBase64 = {
            vehiculo: null,
            corte: null,
            apertura: null,
            cables: null
        };


        // Muestra una alerta flotante
        function mostrarAlerta(mensaje, tipo = 'info') {
            let alerta = document.getElementById('alerta');
            if (!alerta) {
                alerta = document.createElement('div');
                alerta.id = 'alerta';
                document.body.appendChild(alerta);
            }
            alerta.className = `alerta ${tipo}`;
            alerta.innerHTML = mensaje;
            
            setTimeout(() => { alerta.classList.add('show'); }, 50);
            setTimeout(() => { alerta.classList.remove('show'); }, 4000);
        }

        // Convierte un archivo de input a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Manejo gen√©rico de input de archivo
        function handleFileInput(event, imageKey, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const label = event.target.nextElementSibling;

            if (file) {
                label.textContent = `Archivo: ${file.name}`;
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                fileToBase64(file).then(base64 => {
                    imagesBase64[imageKey] = base64;
                });
            } else {
                label.textContent = label.getAttribute('data-default-text');
                preview.src = '';
                preview.style.display = 'none';
                imagesBase64[imageKey] = null;
            }
        }

        // Funci√≥n para generar las opciones de un <select>
        function generateOptions(options, defaultSelection = null) {
            return options.map(opt => 
                `<option value="${opt}" ${opt === defaultSelection ? 'selected' : ''}>${opt}</option>`
            ).join('');
        }
        
        // -------------------------------------------------------------
        // L√ìGICA DE B√öSQUEDA (Paso 1)
        // -------------------------------------------------------------
        async function buscarVehiculo() {
            const loading = document.getElementById("loading");
            const marca = document.getElementById("marca").value.trim();
            const modelo = document.getElementById("modelo").value.trim();
            const a√±o = document.getElementById("a√±o").value.trim();

            if (!marca || !modelo || !a√±o) {
                mostrarAlerta("Por favor, ingrese Marca, Modelo y A√±o.", 'error');
                return;
            }

            loading.style.display = "block";
            loading.innerText = "Buscando veh√≠culo existente...";

            try {
                const payload = { action: 'search', marca, modelo, a√±o: Number(a√±o) };
                
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload)
                });

                const jsonRes = await res.json();
                loading.style.display = "none";

                if (!jsonRes.success) {
                    throw new Error(jsonRes.message || "Error desconocido en Apps Script.");
                }
                
                filaIndexExistente = jsonRes.filaIndex || null;
                datosCorteExistente = jsonRes.datosCortes || {};
                
                // Determinar el pr√≥ximo corte a llenar
                nextCorte = 1;
                if (datosCorteExistente.corte1Tipo) { nextCorte = 2; }
                if (datosCorteExistente.corte2Tipo) { nextCorte = 3; }
                if (datosCorteExistente.corte3Tipo) { nextCorte = 4; } // 4 indica lleno

                if (filaIndexExistente) {
                    mostrarAlerta(`‚ö†Ô∏è Veh√≠culo ya existe. Pr√≥ximo corte: ${nextCorte > 3 ? 'Lleno' : nextCorte}`, nextCorte > 3 ? 'error' : 'info');
                    mostrarPaso(2, nextCorte > 3 ? 'full' : 'edit'); 
                } else {
                    nextCorte = 1;
                    mostrarAlerta("‚úÖ Veh√≠culo nuevo. Creando registro.", 'success');
                    mostrarPaso(2, 'new');
                }


            } catch (e) {
                loading.style.display = "none";
                mostrarAlerta("‚ùå Error en funci√≥n buscarVehiculo: " + e.message, 'error');
                console.error("Error en funci√≥n buscarVehiculo:", e);
            }
        }

        // -------------------------------------------------------------
        // L√ìGICA DE ENV√çO (Paso 3)
        // -------------------------------------------------------------
        async function enviar() {
            const loading = document.getElementById("loading");
            
            // 1. Recopilar datos base
            const commonData = {
                colaborador: document.getElementById("colaborador").value.trim(),
                categoria: document.getElementById("categoria").value,
                marca: document.getElementById("marca").value.trim(),
                modelo: document.getElementById("modelo").value.trim(),
                tipoEncendido: document.getElementById("tipoEncendido").value,
                a√±o: Number(document.getElementById("a√±o").value),
                notaImportante: document.getElementById("notaImportante").value.trim(),
                
                action: filaIndexExistente ? 'update' : 'create',
                filaIndex: filaIndexExistente // S√≥lo se usa en 'update'
            };
            
            // 2. Recopilar datos del corte din√°mico (Paso 2)
            const corteData = {
                tipoCorte: document.getElementById(`tipoCorte_${nextCorte}`).value,
                descripcion: document.getElementById(`descCorte_${nextCorte}`).value.trim(),
                corteNumero: nextCorte,
                // Imagen se pasa como objeto { base64: ... }
                imagen: imagesBase64.corte ? { base64: imagesBase64.corte } : null
            };

            if (!corteData.descripcion) {
                mostrarAlerta("La 'Descripci√≥n del Corte' es obligatoria.", 'error');
                return;
            }

            // 3. Recopilar datos de Apertura y Cables (Paso 3)
            const aperturaData = {
                descripcion: document.getElementById("descApertura").value.trim(),
                imagenApertura: imagesBase64.apertura ? { base64: imagesBase64.apertura } : null
            };

            const cablesData = {
                descripcion: document.getElementById("descCables").value.trim(),
                imagenAlimentacion: imagesBase64.cables ? { base64: imagesBase64.cables } : null
            };

            // 4. Construir Payload Final (incluye todas las partes + im√°genes en base64)
            const finalPayload = {
                ...commonData,
                corte: corteData,
                apertura: aperturaData,
                cables: cablesData,
                imagenVehiculo: imagesBase64.vehiculo ? { base64: imagesBase64.vehiculo } : null
            };

            loading.style.display = "block";
            loading.innerText = "Enviando datos y subiendo im√°genes a Drive...";

            try {
                // Llama al Apps Script
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(finalPayload)
                });

                const jsonRes = await res.json();
                loading.style.display = "none";

                if (jsonRes.success) {
                    mostrarAlerta(`‚úÖ ¬°Registro ${finalPayload.action === 'create' ? 'creado' : 'actualizado'} correctamente! Recargando...`, 'success');
                    setTimeout(() => { location.reload(); }, 2000);
                } else {
                    throw new Error(jsonRes.message || "Error desconocido al guardar en Apps Script.");
                }

            } catch (e) {
                loading.style.display = "none";
                mostrarAlerta("‚ùå Error de env√≠o: " + e.message, 'error');
                console.error("Error en funci√≥n enviar:", e);
            }
        }


        // -------------------------------------------------------------
        // GESTI√ìN DE PASOS Y CONTENIDO DIN√ÅMICO
        // -------------------------------------------------------------

        function volverPaso(n) {
            document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
            document.getElementById("step" + n).classList.add("active");
        }

        function mostrarPaso(n, mode = 'new') {
            document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
            document.getElementById("step" + n).classList.add("active");

            if (n === 2) {
                prepararPaso2(mode);
            }
        }

        function prepararPaso2(mode) {
            const common = {
                marca: document.getElementById("marca").value.trim(),
                modelo: document.getElementById("modelo").value.trim(),
                a√±o: document.getElementById("a√±o").value.trim()
            };
            const titleEl = document.getElementById('step2-title');
            const corteContainer = document.getElementById('corte-dinamico-container');
            const nextBtn = document.getElementById('btn-siguiente-step2');
            
            // Limpiar la variable de imagen del corte anterior
            imagesBase64.corte = null; 

            titleEl.innerText = `Veh√≠culo: ${common.marca} ${common.modelo} (${common.a√±o})`;

            if (mode === 'full') {
                corteContainer.innerHTML = '<p class="text-red-600 font-semibold text-center mt-8">üö® El veh√≠culo ya tiene el n√∫mero m√°ximo de cortes (3) registrados.</p>';
                nextBtn.style.display = 'none';
                return;
            }
            
            // Mostrar los cortes existentes como referencia
            let infoExistente = '';
            if (datosCorteExistente.corte1Tipo) {
                infoExistente += `<p class="text-sm">Corte 1 (H): ${datosCorteExistente.corte1Tipo}</p>`;
            }
            if (datosCorteExistente.corte2Tipo) {
                infoExistente += `<p class="text-sm">Corte 2 (L): ${datosCorteExistente.corte2Tipo}</p>`;
            }
            if (datosCorteExistente.corte3Tipo) {
                infoExistente += `<p class="text-sm">Corte 3 (U): ${datosCorteExistente.corte3Tipo}</p>`;
            }

            const cortesExistentesDiv = document.getElementById('cortes-existentes-info');
            cortesExistentesDiv.innerHTML = `<p class="font-bold mb-1">Cortes Existentes:</p>${infoExistente}`;
            cortesExistentesDiv.style.display = (infoExistente ? 'block' : 'none');

            // --- Generar el formulario para el nuevo corte (nextCorte) ---
            const corteLetra = nextCorte === 1 ? 'H' : (nextCorte === 2 ? 'L' : 'U');
            const descLetra = nextCorte === 1 ? 'I' : (nextCorte === 2 ? 'K' : 'V');
            const imgLetra = nextCorte === 1 ? 'J' : (nextCorte === 2 ? 'M' : 'W');
            const labelText = `Seleccionar Imagen Corte ${nextCorte} (${imgLetra})`;
            
            corteContainer.innerHTML = `
                <h3 class="text-lg font-bold mt-4 mb-3 border-b pb-1" style="color:#007bff;">Registro Corte ${nextCorte}</h3>

                <!-- TIPO DE CORTE (${corteLetra}) -->
                <label for="tipoCorte_${nextCorte}">Tipo de Corte ${nextCorte} (${corteLetra})</label>
                <select id="tipoCorte_${nextCorte}">
                    ${generateOptions(TIPO_CORTE_OPTIONS, 'No recomendable')}
                </select>

                <!-- DESCRIPCI√ìN DEL CORTE (${descLetra}) -->
                <label for="descCorte_${nextCorte}">Descripci√≥n del Corte ${nextCorte} (${descLetra})</label>
                <textarea id="descCorte_${nextCorte}" placeholder="Color de cable y ubicaci√≥n detallada." required></textarea>

                <!-- IMAGEN DEL CORTE (${imgLetra}) -->
                <label for="imgCorte_${nextCorte}">${labelText}</label>
                
                <input type="file" id="imgCorte_${nextCorte}" class="input-file-hidden" accept="image/*">
                <label for="imgCorte_${nextCorte}" class="custom-file-upload" data-default-text="${labelText}">${labelText}</label>
                <img id="previewCorte_${nextCorte}" class="image-preview" style="display:none;" alt="Previsualizaci√≥n del corte ${nextCorte}">
            `;
            
            // A√±adir el listener de archivo para el corte din√°mico
            document.getElementById(`imgCorte_${nextCorte}`).addEventListener('change', (e) => {
                handleFileInput(e, 'corte', `previewCorte_${nextCorte}`);
            });

            nextBtn.style.display = 'block';
        }


        // Configuraci√≥n inicial de listeners y opciones
        document.addEventListener('DOMContentLoaded', () => {
             // Listeners de im√°genes est√°ticas (se pasan por su key)
             document.getElementById('imgVehiculo').addEventListener('change', (e) => handleFileInput(e, 'vehiculo', 'previewVehiculo'));
             document.getElementById('imgApertura').addEventListener('change', (e) => handleFileInput(e, 'apertura', 'previewApertura'));
             document.getElementById('imgCables').addEventListener('change', (e) => handleFileInput(e, 'cables', 'previewCables'));
             
             // Llenar opciones de selecci√≥n est√°ticas
             document.getElementById('categoria').innerHTML = generateOptions(CATEGORIA_OPTIONS, 'Carro');
             document.getElementById('tipoEncendido').innerHTML = generateOptions(TIPO_ENCENDIDO_OPTIONS, 'llave');
             
             // Inicializar: mostrar el primer paso
             mostrarPaso(1);
        });
        </script>
        
        
        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 1 (B√öSQUEDA Y COMUNES) -->
        <!-- ============================================================= -->
        <div id="step1" class="step active">
            <h2 class="text-xl font-bold mb-4 text-gray-700">1. Datos de Identificaci√≥n y B√∫squeda</h2>

            <!-- (T) Colaborador -->
            <label for="colaborador">Colaborador (T)</label>
            <input type="text" id="colaborador" placeholder="Tu nombre" required>
            
            <!-- (B) Categor√≠a -->
            <label for="categoria">Categor√≠a (B)</label>
            <select id="categoria"></select>
            
            <!-- (D) Marca -->
            <label for="marca">Marca (D)</label>
            <input type="text" id="marca" placeholder="Ej: Toyota" required>
            
            <!-- (E) Modelo -->
            <label for="modelo">Modelo (E)</label>
            <input type="text" id="modelo" placeholder="Ej: Corolla S" required>
            
            <!-- (F) Tipo de Encendido -->
            <label for="tipoEncendido">Tipo de Encendido (F)</label>
            <select id="tipoEncendido"></select>
            
            <!-- (G) A√±o/Generaci√≥n -->
            <label for="a√±o">A√±o/Generaci√≥n (G)</label>
            <input type="number" id="a√±o" placeholder="Ej: 2020" min="1900" max="2100" required>
            
            <!-- (C) Imagen Veh√≠culo -->
            <label for="imgVehiculo" class="text-sm text-gray-500">Imagen del Veh√≠culo (C)</label>
            <input type="file" id="imgVehiculo" class="input-file-hidden" accept="image/*">
            <label for="imgVehiculo" class="custom-file-upload" data-default-text="Seleccionar Imagen del Veh√≠culo (C)">Seleccionar Imagen del Veh√≠culo (C)</label>
            <img id="previewVehiculo" class="image-preview" style="display:none;" alt="Previsualizaci√≥n del veh√≠culo">

            <button class="btn mt-6" onclick="buscarVehiculo()">
                Continuar y Buscar Veh√≠culo
            </button>

            <div id="loading" class="loading">Cargando...</div>
        </div>
        
        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 2 (CORTE DIN√ÅMICO) -->
        <!-- ============================================================= -->
        <div id="step2" class="step">
            <div class="backBtn" onclick="volverPaso(1)">&#9664; Regresar</div>
            <h2 id="step2-title" class="text-xl font-semibold mb-2 text-gray-700"></h2>
            
            <div id="cortes-existentes-info" class="cortes-existentes-info" style="display:none;">
                <!-- Cortes Existentes se insertan aqu√≠ -->
            </div>

            <div id="corte-dinamico-container">
                <!-- El formulario del Corte 1/2/3 se generar√° aqu√≠ por JavaScript -->
            </div>

            <div class="flex gap-4 mt-6" style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: 50%;" onclick="volverPaso(1)">Regresar</button>
                <button id="btn-siguiente-step2" class="btn" style="width: 50%;" onclick="mostrarPaso(3)">Siguiente (Cables/Notas)</button>
            </div>
        </div>

        <!-- ============================================================= -->
        <!-- CONTENIDO - PASO 3 (APERTURA, CABLES, NOTA) -->
        <!-- ============================================================= -->
        <div id="step3" class="step">
            <div class="backBtn" onclick="mostrarPaso(2, filaIndexExistente ? 'edit' : 'new')">&#9664; Regresar</div>
            <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Detalles Adicionales</h2>

            <!-- (N) Apertura Desc. -->
            <label for="descApertura">Apertura (N)</label>
            <textarea id="descApertura" placeholder="Descripci√≥n del cable de apertura."></textarea>
            
            <!-- (O) Apertura Imagen -->
            <label for="imgApertura">Imagen de la Apertura (O)</label>
            <input type="file" id="imgApertura" class="input-file-hidden" accept="image/*">
            <label for="imgApertura" class="custom-file-upload" data-default-text="Seleccionar Imagen de la Apertura (O)">Seleccionar Imagen de la Apertura (O)</label>
            <img id="previewApertura" class="image-preview" style="display:none;" alt="Previsualizaci√≥n de apertura">

            <!-- (Q) Cables Alimentaci√≥n Desc. -->
            <label for="descCables">Cables de Alimentaci√≥n (Q)</label>
            <textarea id="descCables" placeholder="Descripci√≥n de los cables que alimentan el GPS."></textarea>
            
            <!-- (R) Cables Alimentaci√≥n Imagen -->
            <label for="imgCables">Imagen de los cables de Alimentaci√≥n (R)</label>
            <input type="file" id="imgCables" class="input-file-hidden" accept="image/*">
            <label for="imgCables" class="custom-file-upload" data-default-text="Seleccionar Imagen de Cables de Alimentaci√≥n (R)">Seleccionar Imagen de Cables de Alimentaci√≥n (R)</label>
            <img id="previewCables" class="image-preview" style="display:none;" alt="Previsualizaci√≥n de cables de alimentaci√≥n">

            <!-- (P) Nota Importante -->
            <label for="notaImportante">Nota Importante (P)</label>
            <textarea id="notaImportante" placeholder="Aspectos a tener en cuenta en la instalaci√≥n de GPS en este veh√≠culo."></textarea>
            
            <div class="flex gap-4 mt-6" style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="width: 50%;" onclick="mostrarPaso(2, filaIndexExistente ? 'edit' : 'new')">Regresar</button>
                <button class="btn" style="width: 50%;" onclick="enviar()">Guardar Registro Completo</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
