<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Cortes de Veh√≠culos.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Estilos base con Tailwind */
    body {
        font-family: 'Inter', sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        padding: 1rem;
    }

    .container-wrapper {
        display: flex;
        justify-content: center;
    }

    .form-container {
        max-width: 500px;
        width: 100%;
    }

    .step {
        display: none;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transition: opacity 0.3s ease-in-out;
    }

    .step.active {
        display: block;
        opacity: 1;
    }

    input[type="text"], input[type="number"], select, textarea {
        @apply w-full p-3 mt-1 mb-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500;
    }
    
    .btn {
        @apply bg-blue-600 text-white p-3 rounded-lg cursor-pointer w-full font-semibold mt-4 transition duration-200 hover:bg-blue-700 disabled:opacity-50;
    }

    .btn-secondary {
        @apply bg-gray-500 hover:bg-gray-600 mt-2;
    }

    .opcion-card {
        @apply bg-gray-50 p-4 rounded-lg my-3 border-2 border-gray-200 cursor-pointer transition duration-200 hover:border-blue-500 hover:shadow-md;
    }
</style>
</head>

<body>

<div class="container-wrapper">
    <div class="form-container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Registro de Cortes de Veh√≠culos 1.</h1>

        <!-- Mensajes de Alerta y Loading -->
        <div id="loading" class="text-center py-4 hidden">
            <svg class="animate-spin h-6 w-6 mr-3 inline-block text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-blue-600 font-medium">Procesando...</span>
        </div>
        <div id="messageBox" class="p-4 rounded-lg mb-4 text-sm font-medium hidden" role="alert"></div>

        <!-- PASO 1: B√öSQUEDA Y FILTRO -->
        <div id="step1" class="step active">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">1. Buscar Modelo Existente</h3>

            <label for="colaborador">Colaborador</label>
            <input type="text" id="colaborador" required>

            <label for="marca">Marca</label>
            <input type="text" id="marca" required>

            <label for="modelo">Modelo</label>
            <input type="text" id="modelo" required>

            <label for="anio">A√±o</label>
            <input type="number" id="anio" min="1900" max="2100" required>
            
            <button class="btn" onclick="buscarModelo()">Buscar Modelo</button>
        </div>


        <!-- PASO 2: SELECCI√ìN DE ACCI√ìN (Modelo Encontrado) -->
        <div id="step2" class="step">
            <h3 class="text-xl font-semibold mb-2 text-gray-700">2. Modelo <span id="modeloInfo"></span></h3>
            <p id="infoExistente" class="font-medium text-lg text-green-700 mb-4"></p>

            <h4 class="font-semibold text-gray-700 mb-3">Selecciona la acci√≥n a realizar:</h4>

            <div id="opciones"></div>

            <button class="btn btn-secondary" onclick="mostrarPaso(1)">Regresar a B√∫squeda</button>
        </div>


        <!-- PASO 3: FORMULARIO DIN√ÅMICO (Nuevo o Actualizaci√≥n) -->
        <div id="step3" class="step">
            <h3 id="tituloStep3" class="text-xl font-semibold mb-4 text-gray-700"></h3>

            <!-- Contenido espec√≠fico generado por JS -->
            <div id="contenidoDinamico"></div>

            <!-- Campos Comunes -->
            <h4 class="font-bold text-gray-600 mt-6 mb-2 border-t pt-4">Informaci√≥n Adicional (Opcional)</h4>
            
            <label for="comoDesarmarPlasticos">C√≥mo desarmar pl√°sticos</label>
            <textarea id="comoDesarmarPlasticos" rows="3"></textarea>

            <label for="notaImportante">Nota Importante</label>
            <textarea id="notaImportante" rows="3"></textarea>
            
            <label for="colaboradorFinal">Colaborador (Confirmar)</label>
            <input type="text" id="colaboradorFinal" required>
            
            <button class="btn" onclick="enviar()">Enviar y Guardar</button>
            <button class="btn btn-secondary" onclick="volverPaso(2)">Regresar</button>
        </div>
    </div>
</div>


<script>
// =============================================================
// CONFIGURACI√ìN Y ESTADO GLOBAL
// =============================================================

// *** IMPORTANTE: REEMPLAZA ESTA URL CON LA DE TU NUEVO DESPLIEGUE ***
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyY-UmZxct5BP9JbunSTGAOPOlHRpXFzyVCNnBLtEFT09ZOlpfSWStAn-Ni8sX4gfcZ/exec";

let validaciones = {}; // Almacena {CATEGORIAS: [], TIPO_ENCENDIDO: [], TIPO_CORTE: []}
let datosEncontrados = null; // Almacena { existe: true, rowIndex: 5, ... } o { existe: false }
let accionSeleccionada = "";
let base64Data = {}; // Almacena temporalmente los datos Base64 de las im√°genes


// =============================================================
// UTILIDADES (UI y Archivos)
// =============================================================

function mostrarAlerta(text, type = 'info') {
    const box = document.getElementById("messageBox");
    box.innerText = text;
    box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

    if (type === 'error') {
        box.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400');
    } else if (type === 'success') {
        box.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-400');
    } else {
        box.classList.add('bg-yellow-100', 'text-yellow-700', 'border', 'border-yellow-400');
    }
    box.scrollIntoView({ behavior: 'smooth' });
    setTimeout(() => { box.classList.add('hidden'); }, 8000);
}

function setLoading(isLoading) {
    document.getElementById("loading").classList.toggle("hidden", !isLoading);
    document.querySelectorAll(".step.active .btn").forEach(btn => btn.disabled = isLoading);
}

function mostrarPaso(n) {
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    document.getElementById("step" + n).classList.add("active");
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Sincronizar colaborador al ir al paso final
    if (n === 3) {
        document.getElementById("colaboradorFinal").value = document.getElementById("colaborador").value;
        document.getElementById("colaboradorFinal").disabled = true; // No permitir cambiarlo aqu√≠
    }
}

/** Lee un archivo y lo almacena como Base64 con metadatos. */
function readFileAsBase64(fileInput, key) {
    const file = fileInput.files[0];
    if (!file) {
        base64Data[key] = null;
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        base64Data[key] = {
            base64: e.target.result, // Cadena data:image/...;base64,...
            name: file.name
        };
        const previewId = `preview${key}`;
        const preview = document.getElementById(previewId);
        if (preview) {
            preview.src = e.target.result;
            preview.classList.remove("hidden");
        }
    };
    reader.readAsDataURL(file);
}

// =============================================================
// INICIALIZACI√ìN (Carga de Validaciones)
// =============================================================

window.onload = async () => {
    try {
        setLoading(true);
        const res = await fetch(WEB_APP_URL + "?action=getValidationData");
        const data = await res.json();
        setLoading(false);

        if (data.error) {
            mostrarAlerta("Error al cargar datos de validaci√≥n: " + data.error, true);
            return;
        }

        validaciones = data;

        // Llenar el select de Categor√≠as en el Paso 1
        const catSelect = document.getElementById("categoriaPaso1");
        validaciones.CATEGORIAS.forEach(c => {
            const op = document.createElement("option");
            op.value = c;
            op.innerText = c;
            catSelect.appendChild(op);
        });

    } catch (e) {
        setLoading(false);
        mostrarAlerta("Error de red o Apps Script al inicializar. Revisa tu URL y despliegue.", 'error');
        console.error("Error de fetch inicial:", e);
    }
};


// =============================================================
// PASO 1: B√öSQUEDA (doGet?action=buscarModelo)
// =============================================================

async function buscarModelo() {
    const marca = document.getElementById("marca").value.trim();
    const modelo = document.getElementById("modelo").value.trim();
    const anio = document.getElementById("anio").value.trim();
    const colaborador = document.getElementById("colaborador").value.trim();

    if (!marca || !modelo || !anio || !colaborador) {
        mostrarAlerta("Por favor, completa Marca, Modelo, A√±o y Colaborador.", 'error');
        return;
    }

    setLoading(true);
    try {
        const url = `${WEB_APP_URL}?action=buscarModelo&marca=${encodeURIComponent(marca)}&modelo=${encodeURIComponent(modelo)}&anio=${anio}`;
        const res = await fetch(url);
        datosEncontrados = await res.json();
        setLoading(false);

        if (datosEncontrados.error) {
            mostrarAlerta("Error en la b√∫squeda: " + datosEncontrados.error, 'error');
            return;
        }

        document.getElementById("modeloInfo").innerText = `${marca} ${modelo} (${anio})`;

        if (datosEncontrados.existe === false) {
            // Modelo NO encontrado: ir directamente a crear nuevo
            accionSeleccionada = "nuevoModelo";
            generarFormulario('nuevoModelo');
        } else {
            // Modelo encontrado: Mostrar opciones de actualizaci√≥n
            document.getElementById("infoExistente").innerText = 
                `Modelo encontrado en la fila #${datosEncontrados.rowIndex}. Selecciona lo que deseas agregar/actualizar.`;
            mostrarOpcionesExistentes(datosEncontrados);
            mostrarPaso(2);
        }

    } catch (e) {
        setLoading(false);
        mostrarAlerta("Error de comunicaci√≥n durante la b√∫squeda.", 'error');
        console.error("Error de fetch:", e);
    }
}


// =============================================================
// PASO 2: OPCIONES (Modelo Existente)
// =============================================================

function mostrarOpcionesExistentes(info) {
    const opciones = document.getElementById("opciones");
    opciones.innerHTML = "";

    let html = '';

    // Opci√≥n para Cortes
    let cortesDisp = [];
    if (!info.tieneCorte2) cortesDisp.push("Corte 2");
    if (!info.tieneCorte3) cortesDisp.push("Corte 3");

    if (cortesDisp.length > 0) {
        html += `<div class="opcion-card" onclick="generarFormulario('corteNuevo')">
                    <span class="font-bold text-lg">‚ûï Agregar Corte Nuevo</span>
                    <div class="text-gray-500 text-sm">Disponibles: ${cortesDisp.join(" y ")}</div>
                 </div>`;
    } else {
        html += `<div class="opcion-card opacity-50 cursor-not-allowed">
                    <span class="font-bold text-lg">‚úîÔ∏è Cortes Completos</span>
                    <div class="text-gray-500 text-sm">Ya tiene 3 cortes registrados.</div>
                 </div>`;
    }

    // Apertura
    const aperturaStatus = info.tieneApertura ? 'Actualizar Apertura' : 'Agregar Apertura';
    html += `<div class="opcion-card" onclick="generarFormulario('apertura')">
                <span class="font-bold text-lg">üîë ${aperturaStatus}</span>
                <div class="text-gray-500 text-sm">${info.tieneApertura ? 'Sobrescribe la descripci√≥n/imagen existente.' : 'Agrega el punto de apertura.'}</div>
             </div>`;

    // Cables
    const cablesStatus = info.tieneCables ? 'Actualizar Cables' : 'Agregar Cables de Alimentaci√≥n';
    html += `<div class="opcion-card" onclick="generarFormulario('cables')">
                <span class="font-bold text-lg">üîã ${cablesStatus}</span>
                <div class="text-gray-500 text-sm">${info.tieneCables ? 'Sobrescribe la descripci√≥n/imagen existente.' : 'Agrega la descripci√≥n de cables.'}</div>
             </div>`;

    // Imagen Veh√≠culo
    html += `<div class="opcion-card" onclick="generarFormulario('imagenVehiculoUpdate')">
                <span class="font-bold text-lg">üì∑ Actualizar Imagen del Veh√≠culo</span>
                <div class="text-gray-500 text-sm">Subir una nueva imagen para la columna 'Imagen del vehiculo'.</div>
             </div>`;

    opciones.innerHTML = html;
}

function generarFormulario(accion) {
    accionSeleccionada = accion;
    document.getElementById("contenidoDinamico").innerHTML = ""; // Limpiar
    base64Data = {}; // Limpiar datos de imagen

    // Generar campos de formulario
    const generarSelectHtml = (id, values, label, isRequired = true) => {
        const requiredAttr = isRequired ? 'required' : '';
        const options = values.map(v => `<option value="${v}">${v}</option>`).join('');
        return `
            <label for="${id}">${label}</label>
            <select id="${id}" ${requiredAttr}>
                <option value="" disabled selected>Seleccione...</option>
                ${options}
            </select>
        `;
    };

    const generarInputFile = (id, label, base64Key, isRequired = true) => {
        const requiredAttr = isRequired ? 'required' : '';
        const handler = `onchange="readFileAsBase64(this, '${base64Key}')"`;
        const previewId = `preview${base64Key}`;
        return `
            <label for="${id}">${label}</label>
            <input type="file" id="${id}" accept="image/*" ${requiredAttr} ${handler}>
            <img id="${previewId}" class="w-full max-h-48 object-contain mt-2 rounded-lg hidden border border-gray-300" alt="Vista previa de imagen">
        `;
    };

    let html = '';
    let title = '';

    switch (accion) {
        case 'nuevoModelo':
            title = "3. Registrar Modelo Nuevo";
            // Para nuevo modelo se necesita la Categor√≠a y el primer corte (Corte 1)
            html = `
                ${generarSelectHtml("categoriaNueva", validaciones.CATEGORIAS, "Categor√≠a del Veh√≠culo")}
                <h4 class="font-bold text-gray-600 mt-4">Detalles de Encendido y Corte 1</h4>
                ${generarSelectHtml("tipoEncendido", validaciones.TIPO_ENCENDIDO, "Tipo de Encendido")}
                ${generarInputFile('imgVehiculo', 'Imagen del Veh√≠culo (Opcional)', 'imagenVehiculo', false)}

                ${generarSelectHtml("tipoCorte1", validaciones.TIPO_CORTE, "Tipo de Corte 1")}
                <label for="descCorte1">Descripci√≥n del Corte 1</label>
                <textarea id="descCorte1" required rows="3"></textarea>
                ${generarInputFile('imgCorte1', 'Imagen del Corte 1', 'imagenCorte1')}
            `;
            break;

        case 'corteNuevo':
            title = "3. Agregar Corte Adicional (2 o 3)";
            html = `
                ${generarSelectHtml("tipoCorte", validaciones.TIPO_CORTE, "Tipo de Corte (2 √≥ 3)")}
                <label for="descripcionCorte">Descripci√≥n del Corte</label>
                <textarea id="descripcionCorte" required rows="3"></textarea>
                ${generarInputFile('imgCorte', 'Imagen del Corte', 'imagenCorte')}
            `;
            break;

        case 'apertura':
            title = "3. Agregar/Actualizar Apertura";
            html = `
                <label for="descApertura">Descripci√≥n de la Apertura</label>
                <textarea id="descApertura" required rows="3"></textarea>
                ${generarInputFile('imgApertura', 'Imagen de la Apertura', 'imagenApertura')}
            `;
            break;

        case 'cables':
            title = "3. Agregar/Actualizar Cables de Alimentaci√≥n";
            html = `
                <label for="descCables">Descripci√≥n de Cables de Alimentaci√≥n</label>
                <textarea id="descCables" required rows="3"></textarea>
                ${generarInputFile('imgCables', 'Imagen de los Cables', 'imagenCables')}
            `;
            break;

        case 'imagenVehiculoUpdate':
            title = "3. Actualizar Imagen del Veh√≠culo";
            html = `
                ${generarInputFile('imgVehiculoUpdate', 'Selecciona la nueva imagen del veh√≠culo', 'imagenVehiculo')}
            `;
            break;
    }

    document.getElementById("tituloStep3").innerText = title;
    document.getElementById("contenidoDinamico").innerHTML = html;
    
    // El bot√≥n Regresar debe llevar al Paso 2 si estamos actualizando
    const btnRegresar = document.querySelector("#step3 .btn-secondary");
    if (datosEncontrados && datosEncontrados.existe) {
        btnRegresar.setAttribute('onclick', 'mostrarPaso(2)');
    } else {
        // Si es modelo nuevo, regresa al Paso 1
        btnRegresar.setAttribute('onclick', 'mostrarPaso(1)');
    }
    
    mostrarPaso(3);
}

// =============================================================
// ENV√çO DE DATOS (doPost)
// =============================================================

async function enviar() {
    const colaborador = document.getElementById("colaboradorFinal").value.trim();
    if (!colaborador) {
        mostrarAlerta("El campo Colaborador (Confirmar) es obligatorio.", 'error');
        return;
    }

    const payload = {
        colaborador,
        marca: document.getElementById("marca").value,
        modelo: document.getElementById("modelo").value,
        anio: Number(document.getElementById("anio").value),
        comoDesarmarPlasticos: document.getElementById("comoDesarmarPlasticos").value.trim(),
        notaImportante: document.getElementById("notaImportante").value.trim(),
        accion: accionSeleccionada,
        // Usar el rowIndex solo si el modelo ya existe
        rowIndex: datosEncontrados && datosEncontrados.existe ? datosEncontrados.rowIndex : null
    };

    let valid = true;
    
    switch (accionSeleccionada) {
        case 'nuevoModelo':
            const catNueva = document.getElementById("categoriaNueva").value;
            const tipoEnc = document.getElementById("tipoEncendido").value;
            const tipoCorte1 = document.getElementById("tipoCorte1").value;
            const descCorte1 = document.getElementById("descCorte1").value.trim();

            if (!catNueva || !tipoEnc || !tipoCorte1 || !descCorte1 || !base64Data.imagenCorte1) { valid = false; break; }

            payload.categoria = catNueva;
            payload.tipoEncendido = tipoEnc;
            payload.imagenVehiculo = base64Data.imagenVehiculo; // Puede ser null (Opcional)
            payload.corte1 = { 
                tipoCorte: tipoCorte1, 
                descripcion: descCorte1, 
                imagen: base64Data.imagenCorte1 
            };
            break;

        case 'corteNuevo':
            const tipoCorte = document.getElementById("tipoCorte").value;
            const descripcionCorte = document.getElementById("descripcionCorte").value.trim();

            if (!tipoCorte || !descripcionCorte || !base64Data.imagenCorte) { valid = false; break; }
            
            payload.corte = { 
                tipoCorte: tipoCorte, 
                descripcion: descripcionCorte, 
                imagen: base64Data.imagenCorte 
            };
            payload.categoria = document.getElementById("categoriaPaso1").value; // Necesario para la estructura de carpetas
            break;

        case 'apertura':
            const descApertura = document.getElementById("descApertura").value.trim();

            if (!descApertura || !base64Data.imagenApertura) { valid = false; break; }
            
            payload.apertura = { 
                descripcion: descApertura, 
                imagen: base64Data.imagenApertura 
            };
            payload.categoria = document.getElementById("categoriaPaso1").value;
            break;

        case 'cables':
            const descCables = document.getElementById("descCables").value.trim();

            if (!descCables || !base64Data.imagenCables) { valid = false; break; }
            
            payload.cables = { 
                descripcion: descCables, 
                imagen: base64Data.imagenCables 
            };
            payload.categoria = document.getElementById("categoriaPaso1").value;
            break;

        case 'imagenVehiculoUpdate':
            if (!base64Data.imagenVehiculo) { valid = false; break; }
            payload.imagenVehiculo = base64Data.imagenVehiculo;
            payload.categoria = document.getElementById("categoriaPaso1").value;
            break;
    }

    if (!valid) {
        mostrarAlerta("Por favor, completa todos los campos requeridos (incluyendo las im√°genes).", 'error');
        return;
    }

    setLoading(true);
    try {
        const res = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const jsonResponse = await res.json();
        setLoading(false);

        if (jsonResponse.success) {
            mostrarAlerta("‚úÖ ¬°Guardado Correctamente! Recargando...", 'success');
            setTimeout(() => { location.reload(); }, 2000); 
        } else {
            throw new Error(jsonResponse.error || "Error desconocido al guardar en Apps Script.");
        }

    } catch (e) {
        setLoading(false);
        mostrarAlerta("‚ùå Error de env√≠o: " + e.message, 'error');
        console.error("Error en funci√≥n enviar:", e);
    }
}
</script>

</body>
</html>


